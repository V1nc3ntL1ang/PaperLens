<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PaperLens - è®ºæ–‡åˆ†æåŠ©æ‰‹</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css"
    />
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Markmap for Mindmaps -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4/dist/browser/index.min.js"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />

    <!-- KaTeX JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
    ></script>

    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      /* PDF Viewer Styles */
      .pdf-page-container {
        position: relative;
        margin: 0 auto 20px auto;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      /* PDF æ¸²æŸ“ä¼˜åŒ– */
      .pdf-canvas {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
      }

      /* é’ˆå¯¹é«˜DPIå±å¹•ä¼˜åŒ– */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .pdf-canvas {
          image-rendering: auto;
        }
      }
      /* Force text layer to match canvas */
      /* ä¿®å¤æ–‡æœ¬å±‚æ ·å¼ */
      .textLayer {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        opacity: 1;
        line-height: 1;
        pointer-events: none;
        /* ç§»é™¤ mix-blend-modeï¼Œå¯èƒ½å¯¼è‡´æ¸²æŸ“é—®é¢˜ */
      }

      .textLayer span {
        color: transparent;
        position: absolute;
        white-space: pre;
        cursor: text;
        transform-origin: 0% 0%;
        pointer-events: auto;
        background: transparent;

        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        line-height: 1 !important;
        box-sizing: border-box;

        /* ===== å…³é”®ä¿®å¤ï¼šå¤„ç†è¡Œæœ«ç©ºç™½ ===== */
        word-spacing: 0;
        letter-spacing: 0;
      }

      /* ä¿®å¤è¡Œæœ«å¤šä½™é€‰æ‹©åŒºåŸŸ */
      .textLayer span::after {
        content: none;
      }

      /* é€‰æ‹©æ ·å¼ä¼˜åŒ– */
      .textLayer span::selection {
        background: rgba(59, 130, 246, 0.3);
        color: transparent;
      }

      /* ç¡®ä¿canvaså’Œæ–‡æœ¬å±‚å¯¹é½ */
      .pdf-page-container {
        position: relative;
        display: inline-block;
      }

      .pdf-canvas {
        display: block;
        position: relative;
        z-index: 0; /* canvasåœ¨åº•å±‚ */
      }

      .textLayer {
        z-index: 1; /* æ–‡æœ¬å±‚åœ¨ä¸Šå±‚ */
      }

      /* Floating Menu */
      #selection-menu {
        position: fixed;
        z-index: 1000;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 4px;
        display: none;
        flex-direction: row;
        gap: 4px;
        animation: fadeIn 0.2s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      #selection-menu button {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        font-size: 13px;
        color: #374151;
        background: transparent;
        border-radius: 4px;
        transition: background-color 0.15s;
      }
      #selection-menu button:hover {
        background-color: #f3f4f6;
        color: #2563eb;
      }

      .typing-indicator span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background-color: #3b82f6;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
        margin: 0 2px;
      }
      .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      /* Markdown Styles */
      .prose h1 {
        font-size: 1.5em;
        font-weight: bold;
        margin-top: 1em;
        margin-bottom: 0.5em;
      }
      .prose h2 {
        font-size: 1.25em;
        font-weight: bold;
        margin-top: 1em;
        margin-bottom: 0.5em;
      }
      .prose p {
        margin-bottom: 0.75em;
        line-height: 1.6;
      }
      .prose ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-bottom: 0.75em;
      }
      .prose ol {
        list-style-type: decimal;
        padding-left: 1.5em;
        margin-bottom: 0.75em;
      }
      .prose code {
        background-color: #f3f4f6;
        padding: 0.2em 0.4em;
        border-radius: 0.25em;
        font-family: monospace;
        font-size: 0.9em;
      }
      .prose pre {
        background-color: #1f2937;
        color: white;
        padding: 1em;
        border-radius: 0.5em;
        overflow-x: auto;
        margin-bottom: 1em;
      }
      .prose blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 1em;
        color: #4b5563;
        font-style: italic;
      }

      /* Mindmap specific styles */
      .markmap-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .markmap-svg {
        width: 100%;
        height: 100%;
        background: #f9fafb;
      }

      /* ä¿®å¤æ€ç»´å¯¼å›¾æ–‡å­—æ˜¾ç¤ºé—®é¢˜ */
      #markmap text {
        fill: #1f2937 !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        pointer-events: none !important;
      }

      /* é’ˆå¯¹foreignObjectå†…å®¹ */
      #markmap foreignObject {
        overflow: visible !important;
      }

      #markmap foreignObject div {
        color: #1f2937 !important;
        background: transparent !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        line-height: 1.4 !important;
        padding: 4px 8px !important;
        border-radius: 4px !important;
      }

      /* ç¡®ä¿èŠ‚ç‚¹èƒŒæ™¯é€æ˜ */
      #markmap .markmap-node {
        background: transparent !important;
      }

      /* é«˜äº®æ–‡å­—å¯¹æ¯”åº¦ */
      #markmap .markmap-node text {
        fill: #000000 !important;
        stroke: none !important;
        paint-order: stroke !important;
      }

      /* ä½œè€…ç¼–è¾‘æ¨¡æ€æ¡†åŠ¨ç”» */
      #authors-edit-modal {
        animation: fadeIn 0.2s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* é€šçŸ¥æ ·å¼ */
      .notification {
        animation: slideInRight 0.3s ease-out;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* å¼•ç”¨éªŒè¯æŒ‰é’®æ ·å¼ */
      .verify-ref-btn {
        transition: all 0.2s ease;
      }

      .verify-ref-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
      }

      /* å¼•ç”¨é¡¹æ‚¬åœæ•ˆæœ */
      .reference-item {
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
      }

      .reference-item:hover {
        border-left-color: #3b82f6;
        background-color: #f8fafc;
      }

      /* ç¡®ä¿æ‰€æœ‰å¤–éƒ¨é“¾æ¥æ ·å¼ä¸€è‡´ */
      a[target='_blank'] {
        color: #2563eb;
        text-decoration: none;
        transition: color 0.2s ease;
      }

      a[target='_blank']:hover {
        color: #1d4ed8;
        text-decoration: underline;
      }

      /* èŠå¤©æ¶ˆæ¯ä¸­çš„é“¾æ¥æ ·å¼ */
      .prose-container a {
        color: #2563eb !important;
        text-decoration: none !important;
      }

      .prose-container a:hover {
        color: #1d4ed8 !important;
        text-decoration: underline !important;
      }

      .math-block {
        margin: 1rem 0;
        padding: 0.75rem;
        background-color: #f8fafc;
        border-radius: 0.5rem;
        overflow-x: auto;
        text-align: center;
      }

      .math-inline {
        padding: 0 0.2rem;
      }

      /* KaTeX æ ·å¼ä¼˜åŒ– */
      .chat-content .katex {
        font-size: 1.1em;
      }

      .chat-content .katex-display {
        margin: 0;
        padding: 0;
      }

      /* èŠå¤©æ°”æ³¡ - ä¿®å¤æˆªæ–­å’Œæ»šåŠ¨æ¡é—®é¢˜ */
      .chat-bubble {
        max-width: 85%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        overflow: visible; /* æ”¹ä¸º visibleï¼Œä¸è¦ hidden æˆ– auto */
      }

      .chat-content {
        overflow: visible; /* æ”¹ä¸º visible */
        line-height: 1.8;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      /* åªåœ¨å…¬å¼å—éœ€è¦æ¨ªå‘æ»šåŠ¨æ—¶æ‰æ˜¾ç¤ºæ»šåŠ¨æ¡ */
      .math-block {
        margin: 1rem 0;
        padding: 0.75rem;
        background-color: #f8fafc;
        border-radius: 0.5rem;
        overflow-x: auto; /* åªæœ‰å…¬å¼å—éœ€è¦æ¨ªå‘æ»šåŠ¨ */
        overflow-y: visible;
        text-align: center;
      }

      /* ä»£ç å—å¯ä»¥æ¨ªå‘æ»šåŠ¨ */
      .chat-content pre {
        overflow-x: auto;
        overflow-y: visible;
        max-width: 100%;
      }

      /* ç¡®ä¿æ®µè½å’Œåˆ—è¡¨ä¸è¢«æˆªæ–­ */
      .chat-content p,
      .chat-content ul,
      .chat-content ol,
      .chat-content li {
        overflow: visible;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .chat-content p {
        margin: 0.5rem 0;
      }

      .chat-content ul,
      .chat-content ol {
        padding-left: 1.5rem;
        margin: 0.5rem 0;
      }

      .chat-content li {
        margin: 0.25rem 0;
      }

      .chat-content strong {
        font-weight: 600;
        color: #1e40af;
      }

      .chat-content code {
        background-color: #f1f5f9;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
        word-break: break-word;
      }

      /* KaTeX æ ·å¼ä¼˜åŒ– */
      .chat-content .katex {
        font-size: 1.1em;
      }

      .chat-content .katex-display {
        margin: 0.5rem 0;
        padding: 0.5rem;
        overflow-x: auto;
        overflow-y: visible;
      }

      /* èŠå¤©å†å²å®¹å™¨ - åªæœ‰è¿™ä¸ªéœ€è¦çºµå‘æ»šåŠ¨ */
      #chat-history {
        overflow-y: visible;
        overflow-x: hidden;
      }

      /* ç¬”è®°åŠŸèƒ½æ ·å¼ */
      .page-thumbnail {
        transition: all 0.2s ease;
      }

      .page-thumbnail:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      #global-note-editor,
      #page-note-editor {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        line-height: 1.5;
      }

      #page-thumbnails {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }

      /* ç¬”è®°çŠ¶æ€æŒ‡ç¤ºå™¨ */
      .note-status-saved {
        color: #10b981;
      }

      .note-status-unsaved {
        color: #f59e0b;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        #notes-tab .flex {
          flex-direction: column;
        }

        #notes-tab .w-1\/4 {
          width: 100%;
          max-height: 200px;
        }
      }

      /* æµå¼è¾“å‡ºå…‰æ ‡æ•ˆæœ */
      .streaming-cursor {
          display: inline-block;
          animation: blink 1s infinite;
          color: #3b82f6;
          font-weight: bold;
          margin-left: 2px;
      }

      @keyframes blink {
          0%, 50% { opacity: 1; }
          51%, 100% { opacity: 0; }
      }

      /* æµå¼æ¶ˆæ¯æ ·å¼ */
      .streaming-message .markdown-body {
          min-height: 20px;
      }

      /* ç¡®ä¿ä»£ç å—åœ¨æµå¼è¾“å‡ºæ—¶æ­£å¸¸æ˜¾ç¤º */
      .streaming-message pre {
          white-space: pre-wrap;
          word-break: break-word;
      }

      /* å¹³æ»‘çš„å†…å®¹æ›´æ–° */
      .markdown-body {
          transition: none; /* ç¦ç”¨è¿‡æ¸¡ä»¥é¿å…é—ªçƒ */
      }

      /* æµå¼è¾“å‡ºå…‰æ ‡æ•ˆæœ */
      .streaming-cursor {
          display: inline;
          animation: blink 1s infinite;
          color: #3b82f6;
          font-weight: bold;
          margin-left: 2px;
      }

      @keyframes blink {
          0%, 50% { opacity: 1; }
          51%, 100% { opacity: 0; }
      }

      /* æµå¼æ¶ˆæ¯æ ·å¼ */
      .streaming-message .chat-content {
          display: inline;
      }

      .streaming-message .chat-bubble {
          display: block;
      }

      /* æ•°å­¦å…¬å¼æ ·å¼ */
      .math-block {
          overflow-x: auto;
          margin: 1em 0;
          text-align: center;
      }

      .math-inline {
          display: inline;
      }

      /* ç¡®ä¿å…¬å¼ä¸æ¢è¡Œå¼‚å¸¸ */
      .chat-content .katex-display {
          overflow-x: auto;
          overflow-y: hidden;
      }
      

    </style>
  </head>
  <body class="bg-gray-100 h-screen flex flex-col overflow-hidden">
    <!-- Floating Selection Menu -->
    <div id="selection-menu">
      <button id="btn-translate">
        <i class="fa-solid fa-language mr-2 text-blue-500"></i> ç¿»è¯‘
      </button>
      <div class="w-px h-6 bg-gray-200 my-auto"></div>
      <button id="btn-explain">
        <i class="fa-solid fa-circle-question mr-2 text-green-500"></i> è§£é‡Š
      </button>
      <div class="w-px h-6 bg-gray-200 my-auto"></div>
      <button id="btn-ask-selection">
        <i class="fa-regular fa-comment-dots mr-2 text-purple-500"></i> æé—®
      </button>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-10">
      <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center">
            <i class="fa-solid fa-book-open-reader text-blue-600 text-2xl mr-3"></i>
            <h1 class="text-xl font-bold text-gray-900">
              PaperLens <span class="text-sm font-normal text-gray-500 ml-2">è®ºæ–‡é˜…è¯»åŠ©æ‰‹</span>
            </h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="relative group">
              <button
                id="settings-btn"
                class="text-gray-600 hover:text-blue-600 focus:outline-none"
              >
                <i class="fa-solid fa-gear text-xl"></i>
              </button>
              <!-- Settings Dropdown -->
              <div
                id="settings-dropdown"
                class="hidden absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg py-1 border border-gray-200 z-50 p-4"
              >
                <h3 class="text-sm font-semibold text-gray-700 mb-3">API é…ç½®</h3>
                <div class="mb-3">
                  <label class="block text-xs text-gray-500 mb-1">DeepSeek API Key</label>
                  <input
                    type="password"
                    id="api-key-input"
                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500"
                    placeholder="sk-..."
                    value=""
                  />
                </div>
                <div class="mb-3">
                  <label class="block text-xs text-gray-500 mb-1">æ¨¡å‹ç‰ˆæœ¬</label>
                  <select
                    id="model-select"
                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500"
                  >
                    <option value="deepseek-chat">deepseek-chat</option>
                    <option value="deepseek-coder">deepseek-coder</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="block text-xs text-gray-500 mb-1">API Base URL</label>
                  <input
                    type="text"
                    id="api-url-input"
                    class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500"
                    value="https://api.deepseek.com/v1"
                  />
                </div>
                <button
                  id="save-settings"
                  class="w-full bg-blue-600 text-white rounded py-1 text-sm hover:bg-blue-700"
                >
                  ä¿å­˜
                </button>
              </div>
            </div>
            <label
              class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center"
            >
              <i class="fa-solid fa-upload mr-2"></i> ä¸Šä¼  PDF
              <input type="file" id="file-upload" class="hidden" accept="application/pdf" />
            </label>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Left Panel: PDF Viewer -->
      <div class="w-3/5 bg-gray-500 flex flex-col border-r border-gray-300 relative group">
        <!-- PDF Toolbar -->
        <div
          class="bg-gray-800 text-white p-2 flex justify-between items-center text-sm shadow-md z-10"
        >
          <div class="flex items-center space-x-4">
            <span id="page-count-label">0 é¡µ</span>
            <div class="flex items-center space-x-2">
              <button id="zoom-out" class="hover:text-gray-300">
                <i class="fa-solid fa-minus"></i>
              </button>
              <span id="zoom-level">80%</span>
              <button id="zoom-in" class="hover:text-gray-300">
                <i class="fa-solid fa-plus"></i>
              </button>
            </div>
          </div>
          <div id="pdf-loading" class="hidden flex items-center text-yellow-400 text-xs">
            <i class="fa-solid fa-spinner fa-spin mr-2"></i> æ­£åœ¨è§£æ...
          </div>
        </div>

        <!-- PDF Container -->
        <div
          id="pdf-container"
          class="flex-1 overflow-y-auto p-4 text-center custom-scrollbar relative"
        >
          <div
            id="empty-state"
            class="flex flex-col items-center justify-center h-full text-white opacity-70"
          >
            <i class="fa-regular fa-file-pdf text-6xl mb-4"></i>
            <p class="text-lg">è¯·ä¸Šä¼  PDF æ–‡ä»¶ä»¥å¼€å§‹é˜…è¯»</p>
          </div>
          <div id="pdf-viewer" class="inline-block"></div>
        </div>
      </div>

      <!-- Right Panel: Analysis Tools -->
      <div class="w-2/5 bg-white flex flex-col">
        <!-- Tabs -->
        <div class="flex border-b border-gray-200">
          <button
            class="tab-btn flex-1 py-3 text-xs font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 focus:outline-none active-tab"
            data-tab="chat"
          >
            <i class="fa-regular fa-comments mr-[1px]"></i> è®ºæ–‡èŠå¤©
          </button>
          <button
            class="tab-btn flex-1 py-3 text-xs font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 focus:outline-none"
            data-tab="summary"
          >
            <i class="fa-regular fa-file-lines mr-[1px]"></i> æ‘˜è¦åˆ†æ
          </button>
          <button
            class="tab-btn flex-1 py-3 text-xs font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 focus:outline-none"
            data-tab="mindmap"
          >
            <i class="fa-solid fa-sitemap mr-[1px]"></i> æ€ç»´å¯¼å›¾
          </button>
          <button
            class="tab-btn flex-1 py-3 text-xs font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 focus:outline-none"
            data-tab="references"
          >
            <i class="fa-solid fa-list-ol mr-[1px]"></i> å‚è€ƒæ–‡çŒ®
          </button>
          <button
            class="tab-btn flex-1 py-3 text-xs font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 focus:outline-none"
            data-tab="authors"
          >
            <i class="fa-solid fa-users mr-[1px]"></i> ä½œè€…åˆ†æ
          </button>
          <button
            class="tab-btn flex-1 py-3 text-xs font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 focus:outline-none"
            data-tab="recommendations"
          >
            <i class="fa-solid fa-lightbulb mr-[1px]"></i> ç›¸å…³æ¨è
          </button>
          <button
            class="tab-btn flex-1 py-3 text-xs font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 focus:outline-none"
            data-tab="citations"
          >
            <i class="fa-solid fa-quote-left mr-[1px]"></i> è¢«å¼•åˆ†æ
          </button>
          <button
            class="tab-btn flex-1 py-3 text-xs font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 focus:outline-none"
            data-tab="notes"
          >
            <i class="fa-solid fa-note-sticky mr-[1px]"></i> è®ºæ–‡ç¬”è®°
          </button>
        </div>

        <!-- Tab Contents -->
        <div class="flex-1 overflow-y-auto bg-gray-50 relative">
          <!-- Chat Tab -->
          <div id="chat-tab" class="tab-content h-full flex flex-col">
            <div id="chat-history" class="flex-1 p-4 overflow-y-hidden space-y-4">
              <!-- Welcome Message -->
              <div class="flex w-full">
                <div
                  class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 flex-shrink-0"
                >
                  <i class="fa-solid fa-robot text-blue-600 text-sm"></i>
                </div>
                <div
                  class="bg-white p-3 rounded-r-lg rounded-bl-lg shadow-sm border border-gray-100 max-w-[85%] text-sm text-gray-800"
                >
                  ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„è®ºæ–‡åŠ©æ‰‹ã€‚è¯·å…ˆä¸Šä¼ ä¸€ç¯‡ PDF
                  è®ºæ–‡ï¼Œç„¶åä½ å¯ä»¥é—®æˆ‘å…³äºè¿™ç¯‡è®ºæ–‡çš„ä»»ä½•é—®é¢˜ã€‚
                </div>
              </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-white border-t border-gray-200">
              <div class="relative">
                <textarea
                  id="chat-input"
                  rows="3"
                  class="w-full border border-gray-300 rounded-lg pl-3 pr-12 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                  placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                ></textarea>
                <button
                  id="send-btn"
                  class="absolute right-2 bottom-2 p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
              <p class="text-xs text-gray-400 mt-2 text-center">
                DeepSeek æ¨¡å‹å¯èƒ½ä¼šäº§ç”Ÿå¹»è§‰ï¼Œè¯·æ ¸å¯¹åŸæ–‡ã€‚
              </p>
            </div>
          </div>

          <!-- Summary Tab -->
          <div id="summary-tab" class="tab-content hidden h-full p-6 overflow-y-auto">
            <div class="text-center mb-6">
              <button
                id="generate-summary-btn"
                class="bg-blue-600 text-white px-6 py-2 rounded-full shadow hover:bg-blue-700 transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> ç”Ÿæˆæ ¸å¿ƒæ‘˜è¦
              </button>
            </div>
            <div id="summary-content" class="prose prose-sm max-w-none">
              <!-- Summary will appear here -->
              <div class="text-center text-gray-400 mt-10">
                <i class="fa-regular fa-clipboard text-4xl mb-3"></i>
                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆè®ºæ–‡æ‘˜è¦</p>
              </div>
            </div>
          </div>

          <!-- Mindmap Tab -->
          <div id="mindmap-tab" class="tab-content hidden h-full flex flex-col">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
              <h3 class="text-sm font-semibold text-gray-700">è®ºæ–‡æ€ç»´å¯¼å›¾</h3>
              <button
                id="generate-mindmap-btn"
                class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center"
              >
                <i class="fa-solid fa-project-diagram mr-2"></i> ç”Ÿæˆ/åˆ·æ–°å¯¼å›¾
              </button>
            </div>
            <div class="flex-1 relative bg-gray-50 overflow-hidden">
              <div
                id="mindmap-loading"
                class="hidden absolute inset-0 z-10 bg-white/80 flex flex-col items-center justify-center"
              >
                <i class="fa-solid fa-spinner fa-spin text-3xl text-blue-600 mb-3"></i>
                <p class="text-gray-600 text-sm">æ­£åœ¨æ„å»ºæ€ç»´å¯¼å›¾ï¼Œè¯·ç¨å€™...</p>
              </div>
              <div
                id="mindmap-empty"
                class="absolute inset-0 flex flex-col items-center justify-center text-gray-400"
              >
                <i class="fa-solid fa-sitemap text-5xl mb-4 opacity-20"></i>
                <p class="text-sm">ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®ç”Ÿæˆæ€ç»´å¯¼å›¾</p>
              </div>
              <svg id="markmap" class="w-full h-full"></svg>
            </div>
          </div>

          <!-- References Tab -->
          <div id="references-tab" class="tab-content hidden h-full p-0 flex flex-col">
            <div class="p-4 border-b border-gray-200 bg-white">
              <div class="flex justify-between items-center">
                <h3 class="font-semibold text-gray-800">å‚è€ƒæ–‡çŒ®åˆ—è¡¨</h3>
                <span
                  id="ref-count"
                  class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs"
                  >0</span
                >
              </div>
            </div>
            <div id="references-list" class="flex-1 overflow-y-auto p-4 space-y-3">
              <div class="text-center text-gray-400 mt-10">
                <i class="fa-solid fa-quote-right text-4xl mb-3"></i>
                <p>æœªæ£€æµ‹åˆ°å‚è€ƒæ–‡çŒ®æˆ–å°šæœªä¸Šä¼ è®ºæ–‡</p>
              </div>
            </div>
          </div>

          <!-- Recommendations Tab -->
          <div id="recommendations-tab" class="tab-content hidden h-full flex flex-col">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
              <h3 class="text-sm font-semibold text-gray-700">ç›¸å…³è®ºæ–‡æ¨è</h3>
              <button
                id="generate-recommendations-btn"
                class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center"
              >
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> ç”Ÿæˆæ¨è
              </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
              <div id="recommendations-content">
                <div class="text-center text-gray-400 mt-10">
                  <i class="fa-solid fa-lightbulb text-4xl mb-3 opacity-20"></i>
                  <p class="text-sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–ç›¸å…³è®ºæ–‡æ¨è</p>
                  <p class="text-xs text-gray-300 mt-2">åŸºäº OpenAlex æ•°æ®åº“</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ä½œè€…åˆ†æ Tab -->
          <div id="authors-tab" class="tab-content hidden h-full flex flex-col">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
              <h3 class="text-sm font-semibold text-gray-700">ä½œè€…ä¸å›¢é˜Ÿåˆ†æ</h3>
              <div class="flex space-x-2">
                <button
                  id="edit-authors-btn"
                  class="bg-gray-200 text-gray-700 px-4 py-1.5 rounded text-xs hover:bg-gray-300 transition-colors disabled:opacity-50 flex items-center"
                >
                  <i class="fa-solid fa-pen-to-square mr-2"></i> ç¼–è¾‘ä½œè€…
                </button>
                <button
                  id="analyze-authors-btn"
                  class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center"
                >
                  <i class="fa-solid fa-user-graduate mr-2"></i> åˆ†æä½œè€…
                </button>
              </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
              <div id="authors-content">
                <div class="text-center text-gray-400 mt-10">
                  <i class="fa-solid fa-users text-4xl mb-3 opacity-20"></i>
                  <p class="text-sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ†æè®ºæ–‡ä½œè€…ä¿¡æ¯</p>
                  <p class="text-xs text-gray-300 mt-2">åŒ…æ‹¬æœºæ„èƒŒæ™¯ã€ç ”ç©¶å›¢é˜Ÿå’Œè¿‡å¾€ä½œå“</p>
                </div>
              </div>
            </div>
            <!-- ä½œè€…ç¼–è¾‘æ¨¡æ€æ¡† -->
            <div
              id="authors-edit-modal"
              class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
            >
              <div
                class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden"
              >
                <div class="flex justify-between items-center p-4 border-b">
                  <h3 class="font-semibold text-lg">ç¼–è¾‘ä½œè€…ä¿¡æ¯</h3>
                  <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-times text-xl"></i>
                  </button>
                </div>

                <div class="p-4 overflow-y-auto">
                  <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >ä½œè€…åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ªä½œè€…)</label
                    >
                    <textarea
                      id="authors-textarea"
                      rows="6"
                      class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                      placeholder="è¯·è¾“å…¥ä½œè€…å§“åï¼Œæ¯è¡Œä¸€ä¸ª..."
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                      æç¤ºï¼šåˆ é™¤é”™è¯¯çš„ä½œè€…ï¼Œæ·»åŠ é—æ¼çš„ä½œè€…ï¼Œç¡®ä¿å§“åå‡†ç¡®
                    </p>
                  </div>

                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <div class="flex items-start">
                      <i class="fa-solid fa-lightbulb text-blue-600 mr-2 mt-0.5"></i>
                      <div class="text-sm text-blue-700">
                        <strong>ç¼–è¾‘å»ºè®®ï¼š</strong>
                        <ul class="mt-1 space-y-1">
                          <li>â€¢ ç¡®ä¿ä½œè€…å§“åæ‹¼å†™å‡†ç¡®</li>
                          <li>â€¢ åˆ é™¤è‡ªåŠ¨æå–é”™è¯¯çš„ä½œè€…</li>
                          <li>â€¢ æ·»åŠ è®ºæ–‡ä¸­é—æ¼çš„ä½œè€…</li>
                          <li>â€¢ ä¿æŒä½œè€…é¡ºåºä¸è®ºæ–‡ä¸€è‡´</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex justify-end space-x-3 p-4 border-t bg-gray-50">
                  <button
                    id="cancel-edit"
                    class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors"
                  >
                    å–æ¶ˆ
                  </button>
                  <button
                    id="save-authors"
                    class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors flex items-center"
                  >
                    <i class="fa-solid fa-check mr-2"></i> ä¿å­˜å¹¶é‡æ–°åˆ†æ
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- å¼•ç”¨åˆ†æ Tab -->
          <div id="citations-tab" class="tab-content hidden h-full flex flex-col">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
              <h3 class="text-sm font-semibold text-gray-700">è®ºæ–‡å¼•ç”¨åˆ†æ</h3>
              <button
                id="get-citations-btn"
                class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center"
              >
                <i class="fa-solid fa-magnifying-glass mr-2"></i> æŸ¥æ‰¾å¼•ç”¨
              </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
              <div id="citations-content">
                <div class="text-center text-gray-400 mt-10">
                  <i class="fa-solid fa-quote-left text-4xl mb-3 opacity-20"></i>
                  <p class="text-sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥æ‰¾å¼•ç”¨è¿™ç¯‡è®ºæ–‡çš„å…¶ä»–æ–‡çŒ®</p>
                  <p class="text-xs text-gray-300 mt-2">åŸºäº Semantic Scholar æ•°æ®åº“</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Notes Tab -->
          <div id="notes-tab" class="tab-content hidden h-full flex flex-col">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
              <h3 class="text-sm font-semibold text-gray-700">è®ºæ–‡ç¬”è®°</h3>
              <div class="flex space-x-2">
                <!-- æ–°å¢å¯¼å‡ºæŒ‰é’® -->
                <button
                  id="export-notes-btn"
                  class="bg-green-600 text-white px-4 py-1.5 rounded text-xs hover:bg-green-700 transition-colors disabled:opacity-50 flex items-center"
                >
                  <i class="fa-solid fa-download mr-2"></i> å¯¼å‡ºç¬”è®°
                </button>
                <button
                  id="save-notes-btn"
                  class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center"
                >
                  <i class="fa-solid fa-floppy-disk mr-2"></i> ä¿å­˜ç¬”è®°
                </button>
                <button
                  id="load-notes-btn"
                  class="bg-gray-600 text-white px-4 py-1.5 rounded text-xs hover:bg-gray-700 transition-colors disabled:opacity-50 flex items-center"
                >
                  <i class="fa-solid fa-folder-open mr-2"></i> åŠ è½½ç¬”è®°
                </button>
              </div>
            </div>

            <div class="flex-1 overflow-hidden flex">
              <!-- å·¦ä¾§ï¼šé¡µé¢ç¼©ç•¥å›¾å¯¼èˆª -->
              <div class="w-1/4 bg-gray-50 border-r border-gray-200 overflow-y-hidden">
                <div class="p-3">
                  <h4 class="text-xs font-semibold text-gray-600 mb-2">é¡µé¢å¯¼èˆª</h4>
                  <div id="page-thumbnails" class="space-y-2">
                    <!-- é¡µé¢ç¼©ç•¥å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                  </div>
                </div>
              </div>

              <!-- å³ä¾§ï¼šç¬”è®°ç¼–è¾‘å™¨ -->
              <div class="flex-1 flex flex-col">
                <!-- å…¨å±€ç¬”è®°åŒºåŸŸ -->
                <div class="border-b border-gray-200 p-4">
                  <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-medium text-gray-700 flex items-center">
                      <i class="fa-solid fa-file-lines mr-2"></i> æ•´ä½“ç¬”è®°
                    </label>
                    <span id="global-note-status" class="text-xs text-gray-500">å·²ä¿å­˜</span>
                  </div>
                  <textarea
                    id="global-note-editor"
                    class="w-full h-32 border border-gray-300 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                    placeholder="åœ¨è¿™é‡Œè®°å½•è®ºæ–‡çš„æ•´ä½“ç†è§£ã€æ ¸å¿ƒè§‚ç‚¹ã€é‡è¦ç»“è®ºç­‰..."
                  ></textarea>
                </div>

                <!-- é¡µé¢ç¬”è®°åŒºåŸŸ -->
                <div class="flex-1 overflow-hidden flex flex-col">
                  <div class="border-b border-gray-200 p-3 bg-white">
                    <div class="flex items-center justify-between">
                      <div>
                        <span id="current-page-label" class="text-sm font-medium text-gray-700"
                          >é¡µé¢ç¬”è®°</span
                        >
                        <span id="page-note-status" class="text-xs text-gray-500 ml-2"
                          >ç¬¬ 1 é¡µ</span
                        >
                      </div>
                      <div class="flex space-x-2">
                        <button
                          id="copy-page-notes"
                          class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200"
                        >
                          <i class="fa-solid fa-copy mr-1"></i> å¤åˆ¶
                        </button>
                        <button
                          id="clear-page-notes"
                          class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200"
                        >
                          <i class="fa-solid fa-trash mr-1"></i> æ¸…ç©º
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="flex-1 overflow-hidden relative">
                    <!-- é¡µé¢é€‰æ‹©å™¨ -->

                    <textarea
                      id="page-note-editor"
                      class="w-full h-full border-none p-4 text-sm focus:outline-none resize-none"
                      placeholder="é€‰æ‹©å·¦ä¾§é¡µé¢ï¼Œä¸ºå½“å‰é¡µé¢æ·»åŠ ç¬”è®°..."
                    ></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
      // State Management
      const state = {
        apiKey: '',
        apiBaseUrl: 'https://api.deepseek.com/v1',
        model: 'deepseek-chat',
        pdfDoc: null,
        scale: 0.8,
        fullText: '',
        extractedReferences: [],
        chatHistory: [
          {
            role: 'system',
            content:
              'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯åŠ©æ‰‹ï¼Œæ“…é•¿å›ç­”å…³äºç»™å®šè®ºæ–‡çš„é—®é¢˜ã€‚è¯·åŸºäºæä¾›çš„è®ºæ–‡å†…å®¹å›ç­”ã€‚',
          },
        ],
        recommendedPapers: [],
        authorsAnalysis: null,
        originalAuthors: [], // å­˜å‚¨åŸå§‹æå–çš„ä½œè€…
        currentAuthors: [], // å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„ä½œè€…
        paperCitations: [], // å­˜å‚¨å¼•ç”¨ä¿¡æ¯
        githubUrls: [],
        notes: {
          global: '', // å…¨å±€ç¬”è®°
          pages: {}, // é¡µé¢ç¬”è®°ï¼š{pageNum: content}
          currentPage: 1, // å½“å‰ç¼–è¾‘çš„é¡µé¢
          hasUnsavedChanges: false,
        },
        pdfHash: null, // å½“å‰PDFçš„å“ˆå¸Œå€¼
      };

      // DOM Elements
      const els = {
        fileUpload: document.getElementById('file-upload'),
        pdfContainer: document.getElementById('pdf-container'),
        pdfViewer: document.getElementById('pdf-viewer'),
        emptyState: document.getElementById('empty-state'),
        zoomIn: document.getElementById('zoom-in'),
        zoomOut: document.getElementById('zoom-out'),
        zoomLevel: document.getElementById('zoom-level'),
        pageCountLabel: document.getElementById('page-count-label'),
        pdfLoading: document.getElementById('pdf-loading'),

        // Settings
        settingsBtn: document.getElementById('settings-btn'),
        settingsDropdown: document.getElementById('settings-dropdown'),
        apiKeyInput: document.getElementById('api-key-input'),
        apiUrlInput: document.getElementById('api-url-input'),
        modelSelect: document.getElementById('model-select'),
        saveSettings: document.getElementById('save-settings'),

        // Tabs
        tabBtns: document.querySelectorAll('.tab-btn'),
        tabContents: document.querySelectorAll('.tab-content'),

        // Chat
        chatHistory: document.getElementById('chat-history'),
        chatInput: document.getElementById('chat-input'),
        sendBtn: document.getElementById('send-btn'),

        // Summary
        generateSummaryBtn: document.getElementById('generate-summary-btn'),
        summaryContent: document.getElementById('summary-content'),

        // Mindmap
        generateMindmapBtn: document.getElementById('generate-mindmap-btn'),
        mindmapLoading: document.getElementById('mindmap-loading'),
        mindmapEmpty: document.getElementById('mindmap-empty'),

        // References
        referencesList: document.getElementById('references-list'),
        refCount: document.getElementById('ref-count'),

        // Recommendations
        generateRecommendationsBtn: document.getElementById('generate-recommendations-btn'),
        recommendationsContent: document.getElementById('recommendations-content'),

        // Authors Analysis
        analyzeAuthorsBtn: document.getElementById('analyze-authors-btn'),
        authorsContent: document.getElementById('authors-content'),

        editAuthorsBtn: document.getElementById('edit-authors-btn'),
        authorsEditModal: document.getElementById('authors-edit-modal'),
        closeEditModal: document.getElementById('close-edit-modal'),
        cancelEdit: document.getElementById('cancel-edit'),
        saveAuthors: document.getElementById('save-authors'),
        authorsTextarea: document.getElementById('authors-textarea'),

        getCitationsBtn: document.getElementById('get-citations-btn'),
        citationsContent: document.getElementById('citations-content'),
      };

      // ç¬”è®°ç›¸å…³çš„DOMå…ƒç´ 
      const noteElements = {
        notesTab: document.getElementById('notes-tab'),
        globalNoteEditor: document.getElementById('global-note-editor'),
        pageNoteEditor: document.getElementById('page-note-editor'),
        pageThumbnails: document.getElementById('page-thumbnails'),
        currentPageLabel: document.getElementById('current-page-label'),
        exportNotesBtn: document.getElementById('export-notes-btn'),
        saveNotesBtn: document.getElementById('save-notes-btn'),
        loadNotesBtn: document.getElementById('load-notes-btn'),
        copyPageNotes: document.getElementById('copy-page-notes'),
        clearPageNotes: document.getElementById('clear-page-notes'),
      };

      // --- Initialization ---

      // Toggle Settings
      els.settingsBtn.addEventListener('click', e => {
        e.stopPropagation();
        els.settingsDropdown.classList.toggle('hidden');
      });

      // Save Settings
      els.saveSettings.addEventListener('click', () => {
        state.apiKey = els.apiKeyInput.value;
        state.apiBaseUrl = els.apiUrlInput.value;
        state.model = els.modelSelect.value;
        els.settingsDropdown.classList.add('hidden');
        alert('è®¾ç½®å·²ä¿å­˜');
      });

      window.addEventListener('beforeunload', () => {
        state.apiKey = '';
        if (els.apiKeyInput) {
          els.apiKeyInput.value = '';
        }
      });

      // Close settings when clicking outside
      document.addEventListener('click', e => {
        if (!els.settingsDropdown.contains(e.target) && e.target !== els.settingsBtn) {
          els.settingsDropdown.classList.add('hidden');
        }
      });

      // Tab Switching
      els.tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          // Remove active class from all
          els.tabBtns.forEach(b => {
            b.classList.remove('active-tab', 'text-blue-600', 'border-blue-600');
            b.classList.add('border-transparent', 'text-gray-500');
          });

          // Add active class to clicked
          btn.classList.add('active-tab', 'text-blue-600', 'border-blue-600');
          btn.classList.remove('border-transparent', 'text-gray-500');

          // Show content
          els.tabContents.forEach(c => c.classList.add('hidden'));
          document.getElementById(`${btn.dataset.tab}-tab`).classList.remove('hidden');
        });
      });

      // Force styling for active tab on load
      document.querySelector('.active-tab').classList.add('text-blue-600', 'border-blue-600');
      document.querySelector('.active-tab').classList.remove('border-transparent', 'text-gray-500');

      // --- PDF Handling ---

      els.fileUpload.addEventListener('change', async e => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.type !== 'application/pdf') {
          alert('è¯·ä¸Šä¼  PDF æ–‡ä»¶');
          return;
        }

        // 1. Frontend Visual Render (Client-side for speed/UX)
        renderPdfVisually(file);

        // 2. Backend Processing (For text & analysis)
        uploadPdfToBackend(file);
      });

      function renderPdfVisually(file) {
        els.emptyState.classList.add('hidden');
        els.pdfLoading.classList.remove('hidden');
        els.pdfViewer.innerHTML = '';

        const fileReader = new FileReader();
        fileReader.onload = async function () {
          const typedarray = new Uint8Array(this.result);
          try {
            const loadingTask = pdfjsLib.getDocument(typedarray);
            state.pdfDoc = await loadingTask.promise;
            els.pageCountLabel.textContent = `${state.pdfDoc.numPages} é¡µ`;

            // Render pages (progressive)
            for (let pageNum = 1; pageNum <= state.pdfDoc.numPages; pageNum++) {
              await renderPage(pageNum);
            }
            els.pdfLoading.classList.add('hidden');
          } catch (error) {
            console.error('Error rendering PDF:', error);
          }
        };
        fileReader.readAsArrayBuffer(file);
      }

      async function uploadPdfToBackend(file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
          // Update UI to show backend processing
          addMessageToChat('assistant', 'ğŸ“„ æ­£åœ¨åå°è§£æè®ºæ–‡æ–‡æœ¬å’Œæå–å¼•ç”¨...');

          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
            headers: {
              'X-API-Key': state.apiKey,
            },
          });

          if (!response.ok) throw new Error('ä¸Šä¼ å¤±è´¥');

          const data = await response.json();
          state.fullText = data.text;
          state.extractedReferences = data.references;
          // ç¡®ä¿ä¿å­˜æ ‡é¢˜å’Œä½œè€…ä¿¡æ¯
          state.paperTitle = data.title || '';
          state.paperAuthors = data.authors || [];
          if (data.github_urls) {
            state.githubUrls = data.github_urls;
          }
          // Update UI
          renderReferences();
          updateSystemContext();
          // ç¬”è®°åˆå§‹åŒ–
          setupNotesAfterUpload();
        } catch (error) {
          console.error('Backend error:', error);
          addMessageToChat('assistant', 'âŒ PDF è§£æå¤±è´¥: ' + error.message);
        }
      }

      async function renderPage(num) {
        try {
          const page = await state.pdfDoc.getPage(num);

          // æé«˜æ¸²æŸ“è´¨é‡
          const dpi = 150;
          const scale = (dpi / 96) * state.scale;
          const viewport = page.getViewport({ scale: scale });

          // Create Container
          const pageContainer = document.createElement('div');
          pageContainer.className = 'pdf-page-container';
          pageContainer.style.width = `${viewport.width}px`;
          pageContainer.style.height = `${viewport.height}px`;
          pageContainer.style.position = 'relative'; // ç¡®ä¿ç›¸å¯¹å®šä½

          pageContainer.style.setProperty('--scale-factor', scale.toString());

          // Create Canvas
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          const outputScale = window.devicePixelRatio || 1;
          canvas.width = Math.floor(viewport.width * outputScale);
          canvas.height = Math.floor(viewport.height * outputScale);
          canvas.style.width = `${viewport.width}px`;
          canvas.style.height = `${viewport.height}px`;
          canvas.className = 'pdf-canvas';

          if (outputScale !== 1) {
            ctx.scale(outputScale, outputScale);
          }

          // Create Text Layer - ä¿®å¤å®šä½
          const textLayerDiv = document.createElement('div');
          textLayerDiv.className = 'textLayer';
          textLayerDiv.style.width = `${viewport.width}px`;
          textLayerDiv.style.height = `${viewport.height}px`;
          textLayerDiv.style.position = 'absolute'; // ç»å¯¹å®šä½
          textLayerDiv.style.top = '0';
          textLayerDiv.style.left = '0';
          textLayerDiv.style.overflow = 'hidden';
          textLayerDiv.style.lineHeight = '1.0'; // ç¡®ä¿è¡Œé«˜ä¸€è‡´

          // Append elements
          pageContainer.appendChild(canvas);
          pageContainer.appendChild(textLayerDiv);
          els.pdfViewer.appendChild(pageContainer);

          // Render Canvas
          const renderContext = {
            canvasContext: ctx,
            viewport: viewport,
            intent: 'display',
          };

          await page.render(renderContext).promise;

          // æ”¹è¿›çš„æ–‡æœ¬å±‚æ¸²æŸ“
          const textContent = await page.getTextContent();

          const textLayerPromise = pdfjsLib.renderTextLayer({
            textContentSource: textContent,
            container: textLayerDiv,
            viewport: viewport,
            textDivs: [],
            enhanceTextSelection: true,
          }).promise;

          // ç­‰å¾…æ–‡æœ¬å±‚æ¸²æŸ“å®Œæˆ
          await textLayerPromise;

          // ===== ä¿®å¤è¡Œæœ«ç©ºç™½é—®é¢˜ =====
          fixTextLayerWhitespace(textLayerDiv);

          // éªŒè¯æ–‡æœ¬å±‚æ˜¯å¦æ­£ç¡®æ¸²æŸ“
          await waitForTextLayerReady(textLayerDiv, num);

          console.log(`ç¬¬ ${num} é¡µæ¸²æŸ“å®Œæˆ`);
        } catch (e) {
          console.error('Render Error:', e);
        }
      }

      // Zoom controls with better scaling
      els.zoomIn.addEventListener('click', () => {
        state.scale += 0.1; // ä»0.2å‡å°åˆ°0.1ï¼Œæ›´ç²¾ç»†çš„æ§åˆ¶
        updateZoom();
      });

      els.zoomOut.addEventListener('click', () => {
        if (state.scale > 0.3) {
          // è°ƒæ•´æœ€å°ç¼©æ”¾
          state.scale -= 0.1;
          updateZoom();
        }
      });

      // æ·»åŠ æ–‡æœ¬å±‚æ¸²æŸ“çŠ¶æ€æ£€æµ‹
      function waitForTextLayerReady(textLayerDiv, pageNum) {
        return new Promise(resolve => {
          const checkReady = () => {
            const textSpans = textLayerDiv.querySelectorAll('span');
            if (textSpans.length > 0) {
              console.log(`ç¬¬ ${pageNum} é¡µæ‰¾åˆ° ${textSpans.length} ä¸ªæ–‡æœ¬span`);
              resolve(true);
            } else {
              setTimeout(checkReady, 100);
            }
          };
          checkReady();
        });
      }

      function updateZoom() {
        els.zoomLevel.textContent = `${Math.round(state.scale * 100)}%`;
        els.pdfViewer.innerHTML = '';
        if (state.pdfDoc) {
          for (let i = 1; i <= state.pdfDoc.numPages; i++) {
            renderPage(i);
          }
        }
      }

      // æ›´æ–°æ‰€æœ‰é¡µé¢çš„ç¼©æ”¾å› å­
      document.querySelectorAll('.pdf-page-container').forEach(container => {
        const dpi = 150;
        const scale = (dpi / 96) * state.scale;
        container.style.setProperty('--scale-factor', scale.toString());
      });

      /**
       * ä¿®å¤æ–‡æœ¬å±‚è¡Œæœ«ç©ºç™½é—®é¢˜
       */
      function fixTextLayerWhitespace(textLayerDiv) {
        const spans = textLayerDiv.querySelectorAll('span');

        spans.forEach(span => {
          const text = span.textContent;

          // æ£€æµ‹å¹¶å¤„ç†è¡Œæœ«ç©ºç™½
          if (text && text !== text.trimEnd()) {
            const trimmedText = text.trimEnd();

            if (trimmedText.length === 0) {
              // æ•´ä¸ª span éƒ½æ˜¯ç©ºç™½ï¼Œéšè—å®ƒ
              span.style.display = 'none';
            } else {
              // è®¡ç®—éœ€è¦ä¿ç•™çš„å®½åº¦æ¯”ä¾‹
              const originalLength = text.length;
              const trimmedLength = trimmedText.length;
              const ratio = trimmedLength / originalLength;

              // è·å–å½“å‰å®½åº¦å¹¶è°ƒæ•´
              const currentWidth = parseFloat(span.style.width);
              if (currentWidth && !isNaN(currentWidth)) {
                span.style.width = `${currentWidth * ratio}px`;
              }

              // æ›´æ–°æ–‡æœ¬å†…å®¹
              span.textContent = trimmedText;
            }
          }

          // ç§»é™¤å¯èƒ½çš„å¤šä½™æ ·å¼
          span.style.border = 'none';
          span.style.padding = '0';
          span.style.margin = '0';
        });
      }

      // --- Text Selection & Floating Menu ---

      const selectionMenu = document.getElementById('selection-menu');
      const btnTranslate = document.getElementById('btn-translate');
      const btnExplain = document.getElementById('btn-explain');
      const btnAsk = document.getElementById('btn-ask-selection');

      // Hide menu on click elsewhere
      document.addEventListener('mousedown', e => {
        if (!selectionMenu.contains(e.target)) {
          selectionMenu.style.display = 'none';
        }
      });

      // Handle Selection
      els.pdfContainer.addEventListener('mouseup', () => {
        const selection = window.getSelection();
        const text = selection.toString().trim();

        if (!text) {
          selectionMenu.style.display = 'none';
          return;
        }

        // Position menu
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();

        // Check if selection is inside PDF container (roughly)
        const containerRect = els.pdfContainer.getBoundingClientRect();

        selectionMenu.style.display = 'flex';
        // Center above selection, ensure it doesn't go off screen
        let top = rect.top - 50;
        let left = rect.left + rect.width / 2 - selectionMenu.offsetWidth / 2;

        if (top < 0) top = rect.bottom + 10;
        if (left < 10) left = 10;

        selectionMenu.style.top = `${top}px`;
        selectionMenu.style.left = `${left}px`;
      });

      // Helper to switch tab and chat
      function triggerSelectionAction(promptPrefix, autoSend = true) {
        const selection = window.getSelection();
        const text = selection.toString().trim();
        if (!text) return;

        // Switch to chat tab
        const chatTabBtn = document.querySelector('[data-tab="chat"]');
        if (chatTabBtn) chatTabBtn.click();

        selectionMenu.style.display = 'none';
        window.getSelection().removeAllRanges();

        if (autoSend) {
          const query = `${promptPrefix}\n\n"${text}"`;
          els.chatInput.value = query;
          handleSendMessage();
        } else {
          els.chatInput.value = `${promptPrefix} "${text}"`;
          els.chatInput.focus();
        }
      }

      btnTranslate.addEventListener('click', () =>
        triggerSelectionAction('è¯·å°†ä»¥ä¸‹è¿™æ®µè®ºæ–‡å†…å®¹ç¿»è¯‘æˆä¸­æ–‡ï¼š')
      );
      btnExplain.addEventListener('click', () =>
        triggerSelectionAction('è¯·é€šä¿—æ˜“æ‡‚åœ°è§£é‡Šä»¥ä¸‹è¿™æ®µå†…å®¹çš„å«ä¹‰å’ŒèƒŒæ™¯ï¼š')
      );
      btnAsk.addEventListener('click', () => triggerSelectionAction('å…³äºè¿™æ®µå†…å®¹ï¼š', false));

      // --- Text Analysis & Logic ---

      function updateSystemContext() {
        const contextText = state.fullText.substring(0, 30000);

        state.chatHistory = [
          {
            role: 'system',
            content:
              'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯åŠ©æ‰‹ï¼Œæ“…é•¿å›ç­”å…³äºç»™å®šè®ºæ–‡çš„é—®é¢˜ã€‚è¯·åŸºäºæä¾›çš„è®ºæ–‡å†…å®¹å›ç­”ã€‚',
          },
          { role: 'system', content: `è®ºæ–‡å†…å®¹ï¼ˆæ‘˜è¦ï¼‰:\n${contextText}` },
        ];

        // æ„å»ºå®Œæˆæ¶ˆæ¯
        let completeMessage = `âœ… è§£æå®Œæˆï¼åŒ…å« ${state.extractedReferences.length} æ¡å‚è€ƒæ–‡çŒ®ã€‚`;

        // æ·»åŠ  GitHub é“¾æ¥ï¼ˆä½¿ç”¨ HTML æ ¼å¼ï¼‰
        if (state.githubUrls && state.githubUrls.length > 0) {
          completeMessage += '\n\nğŸ“¦ **GitHub ä»“åº“ï¼š**\n';
          state.githubUrls.forEach(url => {
            completeMessage += `- <a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline hover:text-blue-800">${url}</a>\n`;
          });
        }

        completeMessage += '\nä½ å¯ä»¥å¼€å§‹æé—®äº†ã€‚';

        addMessageToChat('assistant', completeMessage);
      }

      function renderReferences() {
        els.refCount.textContent = state.extractedReferences.length;
        els.referencesList.innerHTML = '';

        if (state.extractedReferences.length === 0) {
          els.referencesList.innerHTML = `<div class="text-center text-gray-400 mt-10"><p>æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„å‚è€ƒæ–‡çŒ®æ ¼å¼</p></div>`;
          return;
        }

        state.extractedReferences.forEach((ref, index) => {
          const div = document.createElement('div');
          div.className =
            'reference-item bg-white border border-gray-200 p-3 rounded text-sm text-gray-700 hover:bg-gray-50 transition-colors mb-3';
          const safeRef = ref.replace(/"/g, '&quot;').replace(/'/g, "\\'");

          div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-mono text-blue-600 font-bold mr-2 text-xs mt-0.5">[${
                          index + 1
                        }]</span>
                        <div class="flex-1 text-gray-800 leading-relaxed">${ref}</div>
                    </div>
                    <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-100">
                        <span class="text-xs text-gray-500">
                            <i class="fa-solid fa-clock mr-1"></i> ç‚¹å‡»éªŒè¯å‡†ç¡®æ€§
                        </span>
                        <div class="flex space-x-2">
                            <button class="verify-ref-btn text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 transition-colors flex items-center"
                                    onclick="verifyReference('${safeRef}')">
                                <i class="fa-solid fa-magnifying-glass mr-1"></i> éªŒè¯å¼•ç”¨
                            </button>
                            <button class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded hover:bg-gray-200 transition-colors flex items-center"
                                    onclick="addReferenceToChat('${safeRef}')">
                                <i class="fa-regular fa-comment mr-1"></i> è®¨è®º
                            </button>
                        </div>
                    </div>
                `;
          els.referencesList.appendChild(div);
        });
      }

      // æ·»åŠ è®¨è®ºå¼•ç”¨çš„åŠŸèƒ½
      window.addReferenceToChat = function (refText) {
        const chatTabBtn = document.querySelector('[data-tab="chat"]');
        if (chatTabBtn) chatTabBtn.click();

        const query = `è¯·åˆ†æä»¥ä¸‹å¼•ç”¨çš„é‡è¦æ€§å’Œç›¸å…³æ€§ï¼š\n\n"${refText}"`;
        els.chatInput.value = query;
        els.chatInput.focus();
      };

      // Global function for inline onclick - ä¿®å¤ç‰ˆæœ¬
      window.verifyReference = async function (refText) {
        addMessageToChat('assistant', `ğŸ” æ­£åœ¨ä½¿ç”¨AIéªŒè¯å¼•ç”¨: "${refText.substring(0, 40)}..."`);

        try {
          const response = await fetch('/api/verify_reference', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-API-Key': state.apiKey,
            },
            body: JSON.stringify({
              reference: refText,
              api_base: state.apiBaseUrl,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            if (data.fallback_data) {
              const fallback = data.fallback_data;
              const msg = `âš ï¸ **éªŒè¯æœåŠ¡æš‚æ—¶ä¸å¯ç”¨**\n\n**å¼•ç”¨**: ${fallback.reference_preview}\n**å»ºè®®**: ${fallback.suggestion}`;
              addMessageToChat('assistant', msg);
            } else {
              throw new Error(data.error || `HTTP ${response.status}`);
            }
          } else if (data.found) {
            // æˆåŠŸæ‰¾åˆ°åŒ¹é…è®ºæ–‡ - ä¿®æ”¹æ¶ˆæ¯æ ¼å¼ï¼Œè®©é“¾æ¥åœ¨æ–°çª—å£æ‰“å¼€
            const paper = data.data;
            const matchScore = Math.round((data.match_score || 0) * 100);
            const authors = paper.authors ? paper.authors.map(a => a.name).join(', ') : 'æœªçŸ¥ä½œè€…';
            const year = paper.year || 'æœªçŸ¥å¹´ä»½';
            const citationCount = paper.citationCount || 0;
            const venue = paper.venue || paper.publicationVenue?.name || 'æœªçŸ¥æ¥æº';

            // ä½¿ç”¨Markdownæ ¼å¼ï¼Œé“¾æ¥ä¼šè‡ªåŠ¨è¢«å¤„ç†æˆæ–°çª—å£æ‰“å¼€
            const msg = `âœ… **éªŒè¯æˆåŠŸ** (åŒ¹é…åº¦: ${matchScore}%)\n\n**æ ‡é¢˜**: ${paper.title}\n**å¹´ä»½**: ${year}\n**ä½œè€…**: ${authors}\n**å¼•ç”¨æ•°**: ${citationCount}\n**æ¥æº**: ${venue}\n\n[æŸ¥çœ‹åŸæ–‡](${paper.url})`;
            addMessageToChat('assistant', msg);
          } else {
            // æœªæ‰¾åˆ°åŒ¹é…æˆ–åŒ¹é…åº¦ä½
            if (data.best_candidate) {
              const candidate = data.best_candidate;
              const matchScore = Math.round((data.match_score || 0) * 100);
              const authors = candidate.authors ? candidate.authors.join(', ') : 'æœªçŸ¥ä½œè€…';

              const msg = `âš ï¸ **åŒ¹é…åº¦è¾ƒä½** (${matchScore}%)\n\n**æœ€æ¥è¿‘çš„è®ºæ–‡**:\n**æ ‡é¢˜**: ${candidate.title}\n**å¹´ä»½**: ${candidate.year}\n**ä½œè€…**: ${authors}\n\nå»ºè®®æ‰‹åŠ¨æ ¸å¯¹å¼•ç”¨å‡†ç¡®æ€§ã€‚`;
              addMessageToChat('assistant', msg);
            } else {
              const msg = `âŒ **æœªæ‰¾åˆ°åŒ¹é…è®ºæ–‡**\n\næœç´¢è¯: "${data.search_query_used}"\n\nå»ºè®®ï¼šæ£€æŸ¥å¼•ç”¨æ ¼å¼æˆ–æ‰‹åŠ¨æœç´¢ã€‚`;
              addMessageToChat('assistant', msg);
            }
          }
        } catch (e) {
          console.error('å¼•ç”¨éªŒè¯é”™è¯¯:', e);
          const errorMsg = `âŒ éªŒè¯è¯·æ±‚å¤±è´¥: ${e.message}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚`;
          addMessageToChat('assistant', errorMsg);
        }
      };

      // --- Chat & API Integration ---
      async function callDeepSeekAPI(messages, maxTokens = 500) {
            if (!state.apiKey) {
                throw new Error("è¯·å…ˆåœ¨å³ä¸Šè§’è®¾ç½®ä¸­é…ç½® API Key");
            }

            try {
                // Call Backend Proxy
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': state.apiKey
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: messages,
                        api_base: state.apiBaseUrl // Optional pass through
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'API è¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

      // æµå¼è°ƒç”¨ API - æœ€ç»ˆä¿®å¤ç‰ˆ
      async function callDeepSeekAPIStream(messages, onChunk, onComplete, onError) {
          if (!state.apiKey) {
              onError(new Error('è¯·å…ˆåœ¨å³ä¸Šè§’è®¾ç½®ä¸­é…ç½® API Key'));
              return;
          }

          let hasCompleted = false;

          // å®‰å…¨è°ƒç”¨ onCompleteï¼Œç¡®ä¿åªè°ƒç”¨ä¸€æ¬¡
          const safeComplete = (content) => {
              if (hasCompleted) {
                  console.log('onComplete å·²è°ƒç”¨è¿‡ï¼Œè·³è¿‡');
                  return;
              }
              hasCompleted = true;
              console.log('è°ƒç”¨ onCompleteï¼Œå†…å®¹é•¿åº¦:', content.length);
              onComplete(content);
          };

          try {
              const response = await fetch('/api/chat/stream', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-API-Key': state.apiKey,
                  },
                  body: JSON.stringify({
                      model: state.model,
                      messages: messages,
                      api_base: state.apiBaseUrl,
                      stream: true
                  }),
              });

              if (!response.ok) {
                  const err = await response.json().catch(() => ({ error: 'API è¯·æ±‚å¤±è´¥' }));
                  throw new Error(err.error || `API è¯·æ±‚å¤±è´¥: ${response.status}`);
              }

              const reader = response.body.getReader();
              const decoder = new TextDecoder('utf-8');
              let fullContent = '';
              let buffer = '';

              while (true) {
                  const { done, value } = await reader.read();

                  if (done) {
                      console.log('reader doneï¼Œè°ƒç”¨ safeComplete');
                      safeComplete(fullContent);
                      break;  // ç›´æ¥é€€å‡ºå¾ªç¯
                  }

                  buffer += decoder.decode(value, { stream: true });
                  const lines = buffer.split('\n');
                  buffer = lines.pop() || '';

                  for (const line of lines) {
                      if (!line.trim()) continue;
                      
                      // æ£€æŸ¥ [DONE] æ ‡è®°
                      if (line.includes('[DONE]')) {
                          console.log('æ”¶åˆ° [DONE] æ ‡è®°');
                          // ä¸åœ¨è¿™é‡Œè°ƒç”¨ onCompleteï¼Œè®© done åˆ¤æ–­æ¥å¤„ç†
                          continue;
                      }

                      if (line.startsWith('data: ')) {
                          const jsonStr = line.slice(6).trim();
                          if (!jsonStr || jsonStr === '[DONE]') continue;

                          try {
                              const parsed = JSON.parse(jsonStr);
                              const content = parsed.choices?.[0]?.delta?.content || '';

                              if (content) {
                                  fullContent += content;
                                  onChunk(content, fullContent);
                              }
                          } catch (e) {
                              // å¿½ç•¥è§£æé”™è¯¯
                          }
                      }
                  }
              }
          } catch (error) {
              console.error('Stream API Error:', error);
              if (!hasCompleted) {
                  onError(error);
              }
          }
      }

      // åˆ›å»ºé˜²æŠ–æ¸²æŸ“å™¨ - ä¿å­˜å¼•ç”¨ç‰ˆæœ¬
      function createDebouncedRenderer(element, delay = 50) {
          let timeoutId = null;
          let lastContent = '';
          let isDestroyed = false;

          // ç«‹å³è·å–å¹¶ä¿å­˜ chatContent çš„å¼•ç”¨
          const chatContent = element.querySelector('.chat-content');
          
          console.log('æ¸²æŸ“å™¨åˆå§‹åŒ–ï¼ŒchatContent:', chatContent ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');

          return {
              update: (content) => {
                  if (isDestroyed) return;
                  
                  lastContent = content;

                  if (timeoutId) {
                      clearTimeout(timeoutId);
                  }

                  timeoutId = setTimeout(() => {
                      if (isDestroyed) return;
                      
                      // ä½¿ç”¨ä¿å­˜çš„å¼•ç”¨ï¼Œä¸é‡æ–°æŸ¥è¯¢
                      if (chatContent) {
                          try {
                              if (typeof marked !== 'undefined') {
                                  chatContent.innerHTML = marked.parse(lastContent);
                              } else {
                                  chatContent.textContent = lastContent;
                              }
                              if (els.chatHistory) {
                                  els.chatHistory.scrollTop = els.chatHistory.scrollHeight;
                              }
                          } catch (e) {
                              console.error('æ¸²æŸ“å™¨æ›´æ–°é”™è¯¯:', e);
                          }
                      }
                  }, delay);
              },

              flush: () => {
                  if (timeoutId) {
                      clearTimeout(timeoutId);
                      timeoutId = null;
                  }
                  return lastContent;
              },
              
              destroy: () => {
                  isDestroyed = true;
                  if (timeoutId) {
                      clearTimeout(timeoutId);
                      timeoutId = null;
                  }
              },
              
              // è¿”å›ä¿å­˜çš„å¼•ç”¨
              getChatContent: () => chatContent
          };
      }


      // å®Œæˆæµå¼æ¶ˆæ¯ - å¢å¼ºä¿æŠ¤ç‰ˆ
      function finalizeStreamingMessage(element, content) {
          console.log('=== finalizeStreamingMessage å¼€å§‹ ===');
          
          // æ£€æŸ¥å…ƒç´ 
          if (!element) {
              console.error('element ä¸º null');
              return;
          }
          
          // æ£€æŸ¥å…ƒç´ æ˜¯å¦è¿˜åœ¨ DOM ä¸­
          if (!document.body.contains(element)) {
              console.error('element ä¸åœ¨ DOM ä¸­');
              return;
          }

          // ç§»é™¤å…‰æ ‡
          const cursor = element.querySelector('.streaming-cursor');
          if (cursor) cursor.remove();

          // ç§»é™¤æµå¼æ ‡è®°
          element.classList.remove('streaming-message');

          // è·å–å†…å®¹å®¹å™¨
          const chatContent = element.querySelector('.chat-content');
          
          if (!chatContent) {
              console.error('æ‰¾ä¸åˆ° .chat-content');
              console.log('å½“å‰ element.innerHTML:', element.innerHTML);
              
              // å°è¯•é‡æ–°åˆ›å»ºå†…å®¹å®¹å™¨
              const bubble = element.querySelector('.chat-bubble');
              if (bubble) {
                  const newChatContent = document.createElement('div');
                  newChatContent.className = 'chat-content prose prose-sm max-w-none';
                  bubble.innerHTML = '';
                  bubble.appendChild(newChatContent);
                  
                  // ä½¿ç”¨æ–°åˆ›å»ºçš„å®¹å™¨
                  if (typeof processMarkdownWithMath === 'function') {
                      newChatContent.innerHTML = processMarkdownWithMath(content);
                  } else if (typeof marked !== 'undefined') {
                      newChatContent.innerHTML = marked.parse(content);
                  } else {
                      newChatContent.textContent = content;
                  }
                  
                  if (typeof renderMathFormulas === 'function') {
                      renderMathFormulas(newChatContent);
                  }
              }
              return;
          }

          try {
              if (typeof processMarkdownWithMath === 'function') {
                  chatContent.innerHTML = processMarkdownWithMath(content);
              } else if (typeof marked !== 'undefined') {
                  chatContent.innerHTML = marked.parse(content);
              } else {
                  chatContent.textContent = content;
              }
              
              if (typeof renderMathFormulas === 'function') {
                  renderMathFormulas(chatContent);
              }
              
              console.log('æ¸²æŸ“å®Œæˆ');
          } catch (e) {
              console.error('æ¸²æŸ“é”™è¯¯:', e);
              chatContent.textContent = content;
          }

          if (els.chatHistory) {
              els.chatHistory.scrollTop = els.chatHistory.scrollHeight;
          }
          
          console.log('=== finalizeStreamingMessage ç»“æŸ ===');
      }

      // ç»Ÿä¸€çš„ Markdown å’Œå…¬å¼å¤„ç†å‡½æ•°
      function processMarkdownWithMath(text) {
          let processedText = text;
          const mathBlocks = [];
          const mathInlines = [];

          // 1. ä¿æŠ¤å…¬å¼å†…å®¹ï¼Œé¿å…è¢« Markdown ç ´å
          
          // ä¿æŠ¤å—çº§å…¬å¼ \[...\]
          processedText = processedText.replace(/\\\[([\s\S]*?)\\\]/g, (match, formula) => {
              const index = mathBlocks.length;
              mathBlocks.push(formula);
              return `%%MATHBLOCK${index}%%`;
          });

          // ä¿æŠ¤è¡Œå†…å…¬å¼ \(...\)
          processedText = processedText.replace(/\\\(([\s\S]*?)\\\)/g, (match, formula) => {
              const index = mathInlines.length;
              mathInlines.push(formula);
              return `%%MATHINLINE${index}%%`;
          });

          // ä¿æŠ¤å·²æœ‰çš„ $$...$$ å—çº§å…¬å¼
          processedText = processedText.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
              const index = mathBlocks.length;
              mathBlocks.push(formula);
              return `%%MATHBLOCK${index}%%`;
          });

          // ä¿æŠ¤å·²æœ‰çš„ $...$ è¡Œå†…å…¬å¼ï¼ˆæ³¨æ„ä¸è¦åŒ¹é… $$ï¼‰
          processedText = processedText.replace(
              /(?<!\$)\$([^\$\n]+?)\$(?!\$)/g,
              (match, formula) => {
                  const index = mathInlines.length;
                  mathInlines.push(formula);
                  return `%%MATHINLINE${index}%%`;
              }
          );

          // 2. å¤„ç†é“¾æ¥
          processedText = processedText.replace(
              /\[æŸ¥çœ‹åŸæ–‡\]\((https?:\/\/[^\s\)]+)\)/g,
              '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">[æŸ¥çœ‹åŸæ–‡]</a>'
          );

          // 3. ä½¿ç”¨ marked è§£æ Markdown
          let contentHtml = marked.parse(processedText);

          // 4. æ¢å¤å…¬å¼
          mathBlocks.forEach((formula, index) => {
              contentHtml = contentHtml.replace(
                  `%%MATHBLOCK${index}%%`,
                  `<div class="math-block">$$${formula}$$</div>`
              );
              // ä¹Ÿå¤„ç†è¢« <p> åŒ…è£¹çš„æƒ…å†µ
              contentHtml = contentHtml.replace(
                  `<p>%%MATHBLOCK${index}%%</p>`,
                  `<div class="math-block">$$${formula}$$</div>`
              );
          });

          mathInlines.forEach((formula, index) => {
              contentHtml = contentHtml.replace(
                  `%%MATHINLINE${index}%%`,
                  `<span class="math-inline">$${formula}$</span>`
              );
          });

          return contentHtml;
      }

      // æ•°å­¦å…¬å¼æ¸²æŸ“å‡½æ•°
      function renderMathFormulas(element) {
          if (!element) return;

          if (typeof renderMathInElement === 'undefined') {
              console.warn('KaTeX auto-render æœªåŠ è½½');
              return;
          }

          try {
              renderMathInElement(element, {
                  delimiters: [
                      { left: '$$', right: '$$', display: true },
                      { left: '$', right: '$', display: false },
                  ],
                  throwOnError: false,
                  strict: false,
                  trust: true,
                  ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
              });
          } catch (error) {
              console.error('KaTeX æ¸²æŸ“é”™è¯¯:', error);
          }
      }

      function addMessageToChat(role, text) {
        const div = document.createElement('div');
        div.className = 'flex w-full ' + (role === 'user' ? 'justify-end' : '');

        const avatar =
            role === 'user'
                ? `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center ml-2 flex-shrink-0 order-2"><i class="fa-solid fa-user text-gray-600 text-sm"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 flex-shrink-0"><i class="fa-solid fa-robot text-blue-600 text-sm"></i></div>`;

        const bubbleClass =
            role === 'user'
                ? 'bg-blue-600 text-white rounded-l-lg rounded-br-lg'
                : 'bg-white text-gray-800 border border-gray-100 rounded-r-lg rounded-bl-lg';

        if (role === 'assistant') {
            // ä½¿ç”¨ç»Ÿä¸€çš„å¤„ç†å‡½æ•°
            const contentHtml = processMarkdownWithMath(text);

            div.innerHTML = `
                ${avatar}
                <div class="${bubbleClass} p-3 shadow-sm chat-bubble text-sm">
                    <div class="chat-content prose prose-sm max-w-none">
                        ${contentHtml}
                    </div>
                </div>
            `;
        } else {
            // ç”¨æˆ·æ¶ˆæ¯
            div.innerHTML = `
                <div class="${bubbleClass} p-3 shadow-sm chat-bubble text-sm">
                    <div class="chat-content">
                        ${escapeHtml(text)}
                    </div>
                </div>
                ${avatar}
            `;
        }

        els.chatHistory.appendChild(div);

        // æ¸²æŸ“æ•°å­¦å…¬å¼
        if (role === 'assistant') {
            const contentDiv = div.querySelector('.chat-content');
            if (contentDiv) {
                renderMathFormulas(contentDiv);
            }
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        els.chatHistory.scrollTop = els.chatHistory.scrollHeight;
    }

      // HTML è½¬ä¹‰å‡½æ•°
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      
      function showTypingIndicator() {
        const div = document.createElement('div');
        div.id = 'typing-indicator';
        div.className = 'flex w-full';
        div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 flex-shrink-0">
                    <i class="fa-solid fa-robot text-blue-600 text-sm"></i>
                </div>
                <div class="bg-white p-4 rounded-r-lg rounded-bl-lg shadow-sm border border-gray-100">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
        els.chatHistory.appendChild(div);
        els.chatHistory.scrollTop = els.chatHistory.scrollHeight;
      }

      function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
      }

      // Handle Send Message - ä½¿ç”¨ä¿å­˜çš„å¼•ç”¨
      async function handleSendMessage() {
          const text = els.chatInput.value.trim();
          if (!text) return;

          if (!state.fullText && state.chatHistory.length < 3) {
              alert('è¯·å…ˆä¸Šä¼ è®ºæ–‡ PDFï¼');
              return;
          }

          els.chatInput.value = '';
          els.sendBtn.disabled = true;

          // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
          addMessageToChat('user', text);
          state.chatHistory.push({ role: 'user', content: text });

          // åˆ›å»ºæµå¼æ¶ˆæ¯å®¹å™¨
          const streamingElement = createStreamingMessage();
          const renderer = createDebouncedRenderer(streamingElement, 50);
          
          // ä¿å­˜ chatContent å¼•ç”¨
          const chatContent = renderer.getChatContent();
          
          let isCompleted = false;

          try {
              await callDeepSeekAPIStream(
                  state.chatHistory,
                  // onChunk
                  (chunk, fullContent) => {
                      if (!isCompleted) {
                          renderer.update(fullContent);
                      }
                  },
                  // onComplete
                  (finalContent) => {
                      if (isCompleted) {
                          console.warn('onComplete é‡å¤è°ƒç”¨ï¼Œè·³è¿‡');
                          return;
                      }
                      isCompleted = true;
                      
                      console.log('onComplete å¼€å§‹å¤„ç†');
                      
                      // å…ˆé”€æ¯æ¸²æŸ“å™¨ï¼Œåœæ­¢æ‰€æœ‰ setTimeout
                      renderer.destroy();
                      
                      // ç§»é™¤å…‰æ ‡
                      const cursor = streamingElement.querySelector('.streaming-cursor');
                      if (cursor) cursor.remove();
                      
                      // ç§»é™¤æµå¼æ ‡è®°
                      streamingElement.classList.remove('streaming-message');
                      
                      // ä½¿ç”¨ä¿å­˜çš„ chatContent å¼•ç”¨
                      if (chatContent) {
                          try {
                              // å¤„ç† Markdown å’Œå…¬å¼
                              if (typeof processMarkdownWithMath === 'function') {
                                  chatContent.innerHTML = processMarkdownWithMath(finalContent);
                              } else if (typeof marked !== 'undefined') {
                                  chatContent.innerHTML = marked.parse(finalContent);
                              } else {
                                  chatContent.textContent = finalContent;
                              }
                              
                              // æ¸²æŸ“æ•°å­¦å…¬å¼
                              if (typeof renderMathFormulas === 'function') {
                                  renderMathFormulas(chatContent);
                              } else if (typeof renderMathInElement !== 'undefined') {
                                  renderMathInElement(chatContent, {
                                      delimiters: [
                                          { left: '$$', right: '$$', display: true },
                                          { left: '$', right: '$', display: false },
                                          { left: '\\[', right: '\\]', display: true },
                                          { left: '\\(', right: '\\)', display: false },
                                      ],
                                      throwOnError: false
                                  });
                              }
                              
                              console.log('æ¸²æŸ“å®Œæˆ');
                          } catch (e) {
                              console.error('æ¸²æŸ“é”™è¯¯:', e);
                              chatContent.textContent = finalContent;
                          }
                      } else {
                          console.error('chatContent å¼•ç”¨ä¸¢å¤±');
                      }
                      
                      state.chatHistory.push({ role: 'assistant', content: finalContent });
                      
                      if (els.chatHistory) {
                          els.chatHistory.scrollTop = els.chatHistory.scrollHeight;
                      }
                  },
                  // onError
                  (error) => {
                      if (isCompleted) return;
                      isCompleted = true;
                      
                      renderer.destroy();
                      if (streamingElement && streamingElement.parentNode) {
                          streamingElement.remove();
                      }
                      addMessageToChat('assistant', `âš ï¸ é”™è¯¯: ${error.message}`);
                  }
              );
          } catch (error) {
              if (!isCompleted) {
                  renderer.destroy();
                  if (streamingElement && streamingElement.parentNode) {
                      streamingElement.remove();
                  }
                  addMessageToChat('assistant', `âš ï¸ é”™è¯¯: ${error.message}`);
              }
          } finally {
              els.sendBtn.disabled = false;
              els.chatInput.focus();
          }
      }

      // æ‰‹åŠ¨æ¸²æŸ“å…¬å¼çš„å‡½æ•°ï¼ˆå¯åœ¨éœ€è¦æ—¶è°ƒç”¨ï¼‰
      function renderMath(element) {
        if (typeof renderMathInElement !== 'undefined') {
          renderMathInElement(element, {
            delimiters: [
              { left: '$$', right: '$$', display: true },
              { left: '$', right: '$', display: false },
              { left: '\\[', right: '\\]', display: true },
              { left: '\\(', right: '\\)', display: false },
            ],
            throwOnError: false,
            strict: false,
            trust: true,
          });
        }
      }

      // æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½
      document.addEventListener('DOMContentLoaded', function () {
        initNotes();

        // æ£€æŸ¥ marked
        if (typeof marked === 'undefined') {
          console.error('marked.js æœªåŠ è½½ï¼');
        } else {
          marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false,
          });
          console.log('marked.js å·²åŠ è½½');
        }

        // æ£€æŸ¥ KaTeX
        if (typeof katex === 'undefined') {
          console.error('KaTeX æœªåŠ è½½ï¼');
        } else {
          console.log('KaTeX å·²åŠ è½½');
        }

        // æ£€æŸ¥ renderMathInElement
        if (typeof renderMathInElement === 'undefined') {
          console.warn('KaTeX auto-render æœªåŠ è½½ï¼Œå°†ä½¿ç”¨æ‰‹åŠ¨æ¸²æŸ“');
        } else {
          console.log('KaTeX auto-render å·²åŠ è½½');
        }
      });

      // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      els.sendBtn.addEventListener('click', handleSendMessage);

      // è¾“å…¥æ¡†å›è½¦å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰
      els.chatInput.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSendMessage();
        }
      });

      els.chatInput.addEventListener('blur', () => {
        els.chatInput.parentElement.classList.remove('ring-2', 'ring-blue-500');
      });

      // åˆ›å»ºæµå¼æ¶ˆæ¯å®¹å™¨ - æ·»åŠ  ID æ–¹ä¾¿è°ƒè¯•
      function createStreamingMessage() {
          const div = document.createElement('div');
          const messageId = 'streaming-' + Date.now();
          div.id = messageId;
          div.className = 'flex w-full streaming-message';
          div.innerHTML = `
              <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 flex-shrink-0">
                  <i class="fa-solid fa-robot text-blue-600 text-sm"></i>
              </div>
              <div class="bg-white text-gray-800 border border-gray-100 rounded-r-lg rounded-bl-lg p-3 shadow-sm chat-bubble text-sm max-w-[85%]">
                  <div class="chat-content prose prose-sm max-w-none"></div>
                  <span class="streaming-cursor">â–Š</span>
              </div>
          `;
          
          console.log('åˆ›å»ºæµå¼æ¶ˆæ¯å…ƒç´ :', messageId);
          els.chatHistory.appendChild(div);
          els.chatHistory.scrollTop = els.chatHistory.scrollHeight;

          return div;
      }

      // æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹
      function updateStreamingMessage(element, content) {
          const markdownBody = element.querySelector('.markdown-body');
          
          // ä½¿ç”¨ marked æ¸²æŸ“ Markdown
          if (typeof marked !== 'undefined') {
              markdownBody.innerHTML = marked.parse(content);
          } else {
              markdownBody.textContent = content;
          }
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          els.chatHistory.scrollTop = els.chatHistory.scrollHeight;
      }

      // å®Œæˆæµå¼æ¶ˆæ¯
      function finalizeStreamingMessage(element, content) {
          // ç§»é™¤å…‰æ ‡
          const cursor = element.querySelector('.streaming-cursor');
          if (cursor) cursor.remove();
          
          // ç§»é™¤æµå¼æ ‡è®°
          element.classList.remove('streaming-message');
          
          // æœ€ç»ˆæ¸²æŸ“ï¼ˆåŒ…æ‹¬æ•°å­¦å…¬å¼ï¼‰
          const markdownBody = element.querySelector('.markdown-body');
          if (typeof marked !== 'undefined') {
              markdownBody.innerHTML = marked.parse(content);
          }
          
          // æ¸²æŸ“æ•°å­¦å…¬å¼
          renderMath(markdownBody);
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          els.chatHistory.scrollTop = els.chatHistory.scrollHeight;
      }

      function renderMindmap(markdown) {
        if (!window.markmap) {
          console.error('Markmap library not loaded');
          alert('æ€ç»´å¯¼å›¾ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢');
          return;
        }

        const { Transformer, Markmap } = window.markmap;

        if (!Transformer) {
          console.error('Transformer not found');
          alert('æ€ç»´å¯¼å›¾è§£æå™¨åŠ è½½å¤±è´¥');
          return;
        }

        try {
          const transformer = new Transformer();
          const { root } = transformer.transform(markdown);

          const svgEl = document.getElementById('markmap');
          svgEl.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„å†…å®¹

          // è®¾ç½®SVGæ ·å¼
          svgEl.style.background = '#f9fafb';

          // åˆ›å»ºMarkmapå®ä¾‹å¹¶è®¾ç½®é€‰é¡¹
          markmapInstance = Markmap.create(
            svgEl,
            {
              duration: 500,
              nodeMinHeight: 16,
              spacingVertical: 8,
              spacingHorizontal: 50,
              paddingX: 6, // å‡å°èŠ‚ç‚¹å†…è¾¹è·
              maxWidth: 200, // â¬…ï¸ é™åˆ¶èŠ‚ç‚¹å®½åº¦ï¼Œå¼ºåˆ¶æ¢è¡Œ
              autoFit: true,
              color: node => {
                // è®¾ç½®é¢œè‰²æ–¹æ¡ˆ
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                return colors[node.depth % colors.length];
              },
              style: node => {
                // è®¾ç½®æ–‡å­—æ ·å¼
                return {
                  fontSize: Math.max(12, 16 - node.depth * 1.5),
                  fontWeight: node.depth === 0 ? 'bold' : 'normal',
                };
              },
            },
            root
          );

          // å¼ºåˆ¶é‡ç»˜
          setTimeout(() => {
            if (markmapInstance) {
              markmapInstance.fit();
            }
          }, 100);
        } catch (error) {
          console.error('Mindmap rendering error:', error);
          alert('æ€ç»´å¯¼å›¾æ¸²æŸ“å¤±è´¥: ' + error.message);
        }
      }

      // Handle Summary Generation
      els.generateSummaryBtn.addEventListener('click', async () => {
        if (!state.fullText) {
          alert('è¯·å…ˆä¸Šä¼ è®ºæ–‡ PDF');
          return;
        }

        els.generateSummaryBtn.disabled = true;
        els.generateSummaryBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> æ­£åœ¨ç”Ÿæˆ...`;

        const summaryPrompt = `è¯·ç”¨ä¸­æ–‡æ€»ç»“ä»¥ä¸‹å­¦æœ¯è®ºæ–‡çš„æ ¸å¿ƒå†…å®¹ï¼Œè¦æ±‚ï¼š
            1. ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€æ¦‚æ‹¬ç ”ç©¶é—®é¢˜
            2. ç®€è¦è¯´æ˜ä½¿ç”¨çš„æ–¹æ³•æˆ–æŠ€æœ¯è·¯çº¿
            3. æ€»ç»“ä¸»è¦å‘ç°æˆ–è´¡çŒ®
            4. å­—æ•°æ§åˆ¶åœ¨500å­—å·¦å³

            è®ºæ–‡å†…å®¹ç‰‡æ®µï¼š
            ${state.fullText.substring(0, 4000)}`;

        try {
          const messages = [
            {
              role: 'system',
              content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯åŠ©æ‰‹ï¼Œæ“…é•¿ç”¨ç®€æ´æ¸…æ™°çš„è¯­è¨€æ€»ç»“è®ºæ–‡å†…å®¹ã€‚',
            },
            { role: 'user', content: summaryPrompt },
          ];

          const summary = await callDeepSeekAPI(messages, 800);

          els.summaryContent.innerHTML = marked.parse(summary);
        } catch (error) {
          els.summaryContent.innerHTML = `<div class="text-red-500 p-4 bg-red-50 rounded">ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
        } finally {
          els.generateSummaryBtn.disabled = false;
          els.generateSummaryBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> é‡æ–°ç”Ÿæˆ`;
        }
      });

      // Handle Mindmap Generation
      let markmapInstance = null;

      els.generateMindmapBtn.addEventListener('click', async () => {
        if (!state.fullText) {
          alert('è¯·å…ˆä¸Šä¼ è®ºæ–‡ PDF');
          return;
        }

        els.generateMindmapBtn.disabled = true;
        els.mindmapLoading.classList.remove('hidden');
        els.mindmapEmpty.classList.add('hidden');

        // 1. Get Markdown from AI
        const mindmapPrompt = `è¯·åˆ†æè¿™ç¯‡è®ºæ–‡çš„é€»è¾‘ç»“æ„ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªç”¨äºç»˜åˆ¶æ€ç»´å¯¼å›¾çš„ Markdown åˆ—è¡¨ã€‚
            è¦æ±‚ï¼š
            1. æ ¹èŠ‚ç‚¹æ˜¯è®ºæ–‡æ ‡é¢˜ï¼ˆæˆ–è€…"è®ºæ–‡æ¦‚è§ˆ"ï¼‰ã€‚
            2. åŒ…å« "æ‘˜è¦/èƒŒæ™¯", "æ–¹æ³•", "ä¸»è¦ç»“æœ", "ç»“è®º" ç­‰ä¸»è¦åˆ†æ”¯ã€‚
            3. ä½¿ç”¨ Markdown çš„åˆ—è¡¨è¯­æ³• (- æˆ– *)ï¼Œé€šè¿‡ç¼©è¿›è¡¨ç¤ºå±‚çº§ã€‚
            4. å†…å®¹è¦ç²¾ç‚¼æ¦‚æ‹¬ï¼Œä¸è¦é•¿ç¯‡å¤§è®ºã€‚
            5. åªè¾“å‡º Markdown ä»£ç å—æˆ–çº¯æ–‡æœ¬åˆ—è¡¨ï¼Œä¸è¦åŒ…å«å…¶ä»–è§£é‡Šæ€§æ–‡å­—ã€‚

            è®ºæ–‡å‰ 5000 å­—å†…å®¹ï¼š
            ${state.fullText.substring(0, 5000)}`;

        try {
          const messages = [
            {
              role: 'system',
              content: 'ä½ æ˜¯ä¸€ä¸ªæ€ç»´å¯¼å›¾ç”ŸæˆåŠ©æ‰‹ï¼Œè¯·è¾“å‡ºæ¸…æ™°çš„ Markdown åˆ—è¡¨æ ¼å¼æ•°æ®ã€‚',
            },
            { role: 'user', content: mindmapPrompt },
          ];

          let markdown = await callDeepSeekAPI(messages, 1500);

          // Clean up markdown (remove ```markdown wrapper if exists)
          markdown = markdown
            .replace(/```markdown/g, '')
            .replace(/```/g, '')
            .trim();

          // 2. Render Markmap
          renderMindmap(markdown);
        } catch (error) {
          console.error('Mindmap error:', error);
          alert('ç”Ÿæˆæ€ç»´å¯¼å›¾å¤±è´¥: ' + error.message);
          els.mindmapEmpty.classList.remove('hidden');
        } finally {
          els.generateMindmapBtn.disabled = false;
          els.mindmapLoading.classList.add('hidden');
        }
      });

      // è®ºæ–‡æ¨èåŠŸèƒ½ - ä¿®å¤ç‰ˆæœ¬
      function renderRecommendedPapers(response, isFallback = false) {
        // è°ƒè¯•æ—¥å¿—
        console.log('æ”¶åˆ°å“åº”:', response);
        console.log('è®ºæ–‡æ•°é‡:', response.papers ? response.papers.length : 0);

        const papers = response.papers || [];
        const keywordsUsed = response.keywords_used || [];
        const candidatesFound = response.candidates_found || 0;
        const method = response.method || 'search';

        if (!papers || papers.length === 0) {
          els.recommendationsContent.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <i class="fa-solid fa-search text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm">æœªæ‰¾åˆ°ç›¸å…³è®ºæ–‡</p>
                        <p class="text-xs text-gray-300 mt-2">æœç´¢å…³é”®è¯: ${
                          keywordsUsed.join(', ') || 'æ— '
                        }</p>
                    </div>
                `;
          return;
        }

        let html = '';

        if (isFallback) {
          html = `
                    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-600 mr-2"></i>
                            <span class="text-yellow-700 text-sm">ä½¿ç”¨ç¤ºä¾‹æ•°æ®ä¾›å‚è€ƒï¼ŒçœŸå®APIå¯èƒ½æš‚æ—¶å—é™</span>
                        </div>
                    </div>
                `;
        } else {
          html = `
                    <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-sm text-blue-800 font-medium mb-2">
                                    <i class="fa-solid fa-magic mr-2"></i>
                                    ${
                                      method === 'semantic_similarity'
                                        ? 'è¯­ä¹‰ç›¸ä¼¼åº¦æ¨è'
                                        : 'å…³é”®è¯æœç´¢æ¨è'
                                    }
                                </p>
                                <div class="flex flex-wrap gap-1.5 mb-2">
                                    ${keywordsUsed
                                      .map(
                                        keyword =>
                                          `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">${keyword}</span>`
                                      )
                                      .join('')}
                                </div>
                                <p class="text-xs text-blue-600">
                                    <i class="fa-solid fa-database mr-1"></i>
                                    ä» ${candidatesFound} ç¯‡å€™é€‰è®ºæ–‡ä¸­ç­›é€‰å‡º ${
            papers.length
          } ç¯‡æœ€ç›¸å…³è®ºæ–‡
                                </p>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
                                    <i class="fa-solid fa-check-circle mr-1"></i>
                                    ${response.source || 'OpenAlex'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
        }

        papers.forEach((paper, index) => {
          // å¤„ç†ä½œè€…æ ¼å¼ï¼ˆå¯èƒ½æ˜¯å¯¹è±¡æ•°ç»„æˆ–å­—ç¬¦ä¸²æ•°ç»„ï¼‰
          let authors = 'æœªçŸ¥ä½œè€…';
          if (paper.authors && paper.authors.length > 0) {
            if (typeof paper.authors[0] === 'string') {
              authors = paper.authors.join(', ');
            } else {
              authors = paper.authors.map(a => a.name || a).join(', ');
            }
          }

          const year = paper.year || 'æœªçŸ¥å¹´ä»½';
          const citationCount = paper.citationCount || 0;
          const venue = paper.venue || '';
          const abstract = paper.abstract
            ? paper.abstract.length > 200
              ? paper.abstract.substring(0, 200) + '...'
              : paper.abstract
            : 'æš‚æ— æ‘˜è¦';

          // ä½¿ç”¨åç«¯è¿”å›çš„ç›¸å…³åº¦åˆ†æ•°
          const similarityScore = paper.similarity;
          const relevanceScore = paper.relevance;

          // æ ¼å¼åŒ–ç›¸å…³åº¦æ˜¾ç¤º
          let relevanceDisplay = '';
          if (relevanceScore !== undefined && relevanceScore !== null) {
            const relevancePercent = Math.round(relevanceScore * 100);
            const similarityPercent =
              similarityScore !== undefined ? Math.round(similarityScore * 100) : null;

            let scoreColor = 'text-gray-500';
            let bgColor = 'bg-gray-100';
            if (relevancePercent >= 70) {
              scoreColor = 'text-green-700';
              bgColor = 'bg-green-100';
            } else if (relevancePercent >= 50) {
              scoreColor = 'text-blue-700';
              bgColor = 'bg-blue-100';
            } else if (relevancePercent >= 30) {
              scoreColor = 'text-yellow-700';
              bgColor = 'bg-yellow-100';
            }

            relevanceDisplay = `
                        <div class="flex items-center gap-3">
                            <span class="text-xs ${bgColor} ${scoreColor} px-2 py-1 rounded-full font-medium">
                                <i class="fa-solid fa-bullseye mr-1"></i>
                                ç»¼åˆç›¸å…³åº¦: ${relevancePercent}%
                            </span>
                            ${
                              similarityPercent !== null
                                ? `
                                <span class="text-xs text-gray-500">
                                    <i class="fa-solid fa-brain mr-1"></i>
                                    è¯­ä¹‰ç›¸ä¼¼åº¦: ${similarityPercent}%
                                </span>
                            `
                                : ''
                            }
                        </div>
                    `;
          } else {
            relevanceDisplay = `
                        <span class="text-xs text-gray-400">
                            <i class="fa-solid fa-chart-line mr-1"></i>
                            ç›¸å…³åº¦æ’å: #${index + 1}
                        </span>
                    `;
          }

          html += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-800 text-sm flex-1 leading-snug">${
                              paper.title || 'æ— æ ‡é¢˜'
                            }</h4>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full ml-2 flex-shrink-0">#${
                              index + 1
                            }</span>
                        </div>

                        <div class="text-xs text-gray-600 mb-2">
                            <i class="fa-solid fa-user-group mr-1"></i> ${authors}
                        </div>

                        <div class="flex flex-wrap gap-3 text-xs text-gray-500 mb-3">
                            <span><i class="fa-solid fa-calendar mr-1"></i> ${year}</span>
                            <span><i class="fa-solid fa-quote-right mr-1"></i> ${citationCount} å¼•ç”¨</span>
                            ${
                              venue
                                ? `<span><i class="fa-solid fa-book mr-1"></i> ${venue}</span>`
                                : ''
                            }
                        </div>

                        <p class="text-xs text-gray-700 mb-3 leading-relaxed bg-gray-50 p-2 rounded">${abstract}</p>

                        <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                            ${relevanceDisplay}
                            <div class="flex gap-2">
                                ${
                                  paper.url
                                    ? `
                                    <a href="${paper.url}"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        style="color: white !important; background-color: #2563eb;"
                                        class="inline-flex items-center text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 transition-colors shadow-sm">
                                            <i class="fa-solid fa-external-link-alt mr-1.5"></i> æŸ¥çœ‹åŸæ–‡
                                    </a>
                                `
                                    : ''
                                }
                            </div>
                        </div>
                    </div>
                `;
        });

        els.recommendationsContent.innerHTML = html;
      }

      // äº‹ä»¶å¤„ç†å‡½æ•° - ä¿®å¤ç‰ˆæœ¬
      els.generateRecommendationsBtn.addEventListener('click', async () => {
        if (!state.fullText) {
          alert('è¯·å…ˆä¸Šä¼ è®ºæ–‡ PDF');
          return;
        }

        els.generateRecommendationsBtn.disabled = true;
        els.generateRecommendationsBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> æœç´¢ä¸­...`;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        els.recommendationsContent.innerHTML = `
                <div class="text-center py-10">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                    <p class="text-gray-600">æ­£åœ¨ä½¿ç”¨è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢ç›¸å…³è®ºæ–‡...</p>
                    <p class="text-xs text-gray-400 mt-2">è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</p>
                </div>
            `;

        try {
          const response = await fetch('/api/recommend_papers', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              text: state.fullText.substring(0, 3000),
              title: state.paperTitle || '',
              max_results: 10,
            }),
          });

          const result = await response.json();

          console.log('æ¨èAPIå“åº”:', result);
          console.log('papersæ•°é‡:', result.papers ? result.papers.length : 0);

          if (!response.ok) {
            if (result.fallback_used && result.papers) {
              state.recommendedPapers = result.papers;
              // ä¼ é€’æ•´ä¸ª result å¯¹è±¡
              renderRecommendedPapers(result, true);
            } else {
              throw new Error(result.error || `HTTP ${response.status}`);
            }
          } else if (result.success && result.papers && result.papers.length > 0) {
            state.recommendedPapers = result.papers;
            // ä¼ é€’æ•´ä¸ª result å¯¹è±¡
            renderRecommendedPapers(result, false);
            console.log(`æˆåŠŸæ‰¾åˆ° ${result.papers.length} ç¯‡ç›¸å…³è®ºæ–‡`);
          } else if (result.success && (!result.papers || result.papers.length === 0)) {
            // æœç´¢æˆåŠŸä½†æ²¡æœ‰ç»“æœ
            els.recommendationsContent.innerHTML = `
                        <div class="text-center text-gray-400 mt-10">
                            <i class="fa-solid fa-search text-4xl mb-3 opacity-20"></i>
                            <p class="text-sm">æœªæ‰¾åˆ°ç›¸å…³è®ºæ–‡</p>
                            <p class="text-xs text-gray-300 mt-2">æœç´¢å…³é”®è¯: ${
                              (result.keywords_used || []).join(', ') || 'æ— '
                            }</p>
                        </div>
                    `;
          } else {
            throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
          }
        } catch (error) {
          console.error('Recommendation error:', error);
          els.recommendationsContent.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <i class="fa-solid fa-exclamation-triangle text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm">æš‚æ—¶æ— æ³•è·å–æ¨è</p>
                        <p class="text-xs text-gray-300 mt-2">${error.message}</p>
                        <button onclick="location.reload()" class="mt-3 text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded">
                            <i class="fa-solid fa-refresh mr-1"></i> é‡è¯•
                        </button>
                    </div>
                `;
        } finally {
          els.generateRecommendationsBtn.disabled = false;
          els.generateRecommendationsBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> ç”Ÿæˆæ¨è`;
        }
      });

      els.generateRecommendationsBtn.addEventListener('click', async () => {
        if (!state.fullText) {
          alert('è¯·å…ˆä¸Šä¼ è®ºæ–‡ PDF');
          return;
        }

        els.generateRecommendationsBtn.disabled = true;
        els.generateRecommendationsBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> æœç´¢ä¸­...`;

        try {
          const response = await fetch('/api/recommend_papers', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              text: state.fullText.substring(0, 2000), // é™åˆ¶æ–‡æœ¬é•¿åº¦
              max_results: 5,
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¤‡é€‰æ•°æ®
            if (result.fallback_used && result.papers) {
              // æœ‰å¤‡é€‰æ•°æ®ï¼Œæ˜¾ç¤ºè­¦å‘Šä½†ç»§ç»­æ˜¾ç¤ºç»“æœ
              showFallbackWarning(result.error);
              state.recommendedPapers = result.papers;
              renderRecommendedPapers(result.papers, 'ç¤ºä¾‹æŸ¥è¯¢ï¼ˆAPIæš‚æ—¶ä¸å¯ç”¨ï¼‰', true);
            } else {
              throw new Error(result.error || `HTTP ${response.status}`);
            }
          } else if (result.success) {
            // æ­£å¸¸æƒ…å†µ
            state.recommendedPapers = result.papers;
            renderRecommendedPapers(result.papers, result.query_used, false);
          } else {
            throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
          }
        } catch (error) {
          console.error('Recommendation error:', error);
          // å³ä½¿æ˜¯ç½‘ç»œé”™è¯¯ä¹Ÿå°è¯•æ˜¾ç¤ºç¤ºä¾‹æ•°æ®
          els.recommendationsContent.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-yellow-700">
                        <div class="flex items-center mb-2">
                            <i class="fa-solid fa-triangle-exclamation mr-2"></i>
                            <strong>ç½‘ç»œè¿æ¥é—®é¢˜</strong>
                        </div>
                        <p class="mb-3">${error.message}</p>
                        <p class="text-sm mb-3">æ˜¾ç¤ºç¤ºä¾‹è®ºæ–‡æ•°æ®ä¾›å‚è€ƒï¼š</p>
                        ${renderExamplePapers()}
                    </div>
                `;
        } finally {
          els.generateRecommendationsBtn.disabled = false;
          els.generateRecommendationsBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> ç”Ÿæˆæ¨è`;
        }
      });

      function showFallbackWarning(errorMessage) {
        // æ˜¾ç¤ºä¸´æ—¶è­¦å‘Š
        const warningDiv = document.createElement('div');
        warningDiv.className = 'mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg';
        warningDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 mr-2"></i>
                    <span class="text-yellow-700 text-sm">${errorMessage}ï¼Œæ˜¾ç¤ºç¤ºä¾‹æ•°æ®</span>
                </div>
            `;
        els.recommendationsContent.appendChild(warningDiv);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
          warningDiv.remove();
        }, 5000);
      }

      function renderExamplePapers() {
        const examplePapers = [
          {
            title: 'Attention Is All You Need',
            authors: [{ name: 'Ashish Vaswani' }, { name: 'Noam Shazeer' }],
            year: 2017,
            abstract: 'æå‡ºäº†Transformeræ¶æ„ï¼Œå®Œå…¨åŸºäºæ³¨æ„åŠ›æœºåˆ¶ï¼Œæ‘’å¼ƒäº†å¾ªç¯å’Œå·ç§¯ç½‘ç»œ...',
            citationCount: 45000,
            venue: 'NeurIPS',
          },
          {
            title: 'BERT: Pre-training of Deep Bidirectional Transformers',
            authors: [{ name: 'Jacob Devlin' }, { name: 'Ming-Wei Chang' }],
            year: 2018,
            abstract: 'å¼•å…¥äº†BERTæ¨¡å‹ï¼Œé€šè¿‡é¢„è®­ç»ƒæ·±åº¦åŒå‘Transformerè¿›è¡Œè¯­è¨€ç†è§£...',
            citationCount: 35000,
            venue: 'NAACL',
          },
        ];

        return examplePapers
          .map(
            (paper, index) => `
                <div class="bg-white border border-gray-200 rounded-lg p-3 mb-3">
                    <h4 class="font-semibold text-sm">${paper.title}</h4>
                    <p class="text-xs text-gray-600">${paper.authors
                      .map(a => a.name)
                      .join(', ')} Â· ${paper.year}</p>
                    <p class="text-xs text-gray-700 mt-1">${paper.abstract}</p>
                </div>
            `
          )
          .join('');
      }

      // ä½œè€…åˆ†æåŠŸèƒ½
      els.analyzeAuthorsBtn.addEventListener('click', async () => {
        if (!state.fullText) {
          alert('è¯·å…ˆä¸Šä¼ è®ºæ–‡ PDF');
          return;
        }

        els.analyzeAuthorsBtn.disabled = true;
        els.analyzeAuthorsBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> åˆ†æä¸­...`;

        try {
          const response = await fetch('/api/analyze_authors', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              authors: state.paperAuthors,
              title: state.paperTitle, // æ–°å¢ï¼šä¼ é€’è®ºæ–‡æ ‡é¢˜
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            if (result.fallback_data) {
              // ä½¿ç”¨å¤‡é€‰æ•°æ®
              state.authorsAnalysis = result.fallback_data;
              renderAuthorsAnalysis(result.fallback_data, true);
            } else {
              throw new Error(result.error || `HTTP ${response.status}`);
            }
          } else if (result.success) {
            state.authorsAnalysis = result;
            renderAuthorsAnalysis(result, false);
          } else {
            throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
          }
        } catch (error) {
          console.error('ä½œè€…åˆ†æé”™è¯¯:', error);
          els.authorsContent.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <i class="fa-solid fa-exclamation-triangle text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm">ä½œè€…åˆ†æå¤±è´¥</p>
                        <p class="text-xs text-gray-300 mt-2">${error.message}</p>
                    </div>
                `;
        } finally {
          els.analyzeAuthorsBtn.disabled = false;
          els.analyzeAuthorsBtn.innerHTML = `<i class="fa-solid fa-user-graduate mr-2"></i> åˆ†æä½œè€…`;
        }
      });

      function renderAuthorsAnalysis(data, isFallback) {
        let html = '';

        if (isFallback) {
          html = `
                    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-600 mr-2"></i>
                            <span class="text-yellow-700 text-sm">éƒ¨åˆ†ä½œè€…ä¿¡æ¯è·å–å¤±è´¥ï¼Œæ˜¾ç¤ºå¯ç”¨æ•°æ®</span>
                        </div>
                    </div>
                `;
        }

        // å›¢é˜Ÿæ¦‚è§ˆ
        html += `
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fa-solid fa-people-group text-blue-600 mr-2"></i>
                        å›¢é˜Ÿæ¦‚è§ˆ
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center">
                        <div class="bg-blue-50 rounded p-3">
                            <div class="text-2xl font-bold text-blue-600">${
                              data.authors_count
                            }</div>
                            <div class="text-xs text-gray-600">ä½œè€…æ•°é‡</div>
                        </div>
                        <div class="bg-green-50 rounded p-3">
                            <div class="text-2xl font-bold text-green-600">${
                              data.analysis.totalPapers
                            }</div>
                            <div class="text-xs text-gray-600">æ€»è®ºæ–‡æ•°</div>
                        </div>
                        <div class="bg-purple-50 rounded p-3">
                            <div class="text-2xl font-bold text-purple-600">${
                              data.analysis.totalCitations?.toLocaleString() || 0
                            }</div>
                            <div class="text-xs text-gray-600">æ€»å¼•ç”¨æ•°</div>
                        </div>
                        <div class="bg-orange-50 rounded p-3">
                            <div class="text-2xl font-bold text-orange-600">${
                              data.analysis.avgHIndex || 0
                            }</div>
                            <div class="text-xs text-gray-600">å¹³å‡HæŒ‡æ•°</div>
                        </div>
                        <div class="bg-pink-50 rounded p-3">
                            <div class="text-2xl font-bold text-pink-600">${
                              Object.keys(data.analysis.institutionDistribution || {}).length
                            }</div>
                            <div class="text-xs text-gray-600">åˆä½œæœºæ„</div>
                        </div>
                    </div>
                </div>
            `;

        // æœºæ„åˆ†å¸ƒ
        const institutions = data.analysis.institutionDistribution || {};
        if (Object.keys(institutions).length > 0) {
          html += `
                    <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fa-solid fa-building text-indigo-600 mr-2"></i>
                            æœºæ„åˆ†å¸ƒ
                        </h3>
                        <div class="space-y-2">
                `;

          Object.entries(institutions).forEach(([inst, count]) => {
            const percentage = Math.round((count / data.authors_count) * 100);
            html += `
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="text-sm text-gray-700 mb-1">${inst}</div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-indigo-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <span class="ml-3 text-sm font-semibold text-gray-600">${count}äºº</span>
                        </div>
                    `;
          });

          html += `</div></div>`;
        }

        // ç ”ç©¶å…´è¶£è¯äº‘
        const interests = data.analysis.researchInterests || {};
        if (Object.keys(interests).length > 0) {
          html += `
                    <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i>
                            å›¢é˜Ÿç ”ç©¶æ–¹å‘
                        </h3>
                        <div class="flex flex-wrap gap-2">
                `;

          Object.entries(interests).forEach(([interest, count]) => {
            const size = count > 2 ? 'text-sm px-3 py-1.5' : 'text-xs px-2 py-1';
            const color = count > 2 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700';
            html += `<span class="${size} ${color} rounded-full">${interest} (${count})</span>`;
          });

          html += `</div></div>`;
        }

        // ä½œè€…è¯¦ç»†ä¿¡æ¯
        html += `
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fa-solid fa-user-tie text-green-600 mr-2"></i>
                        ä½œè€…è¯¦æƒ…
                    </h3>
                    <div class="space-y-4">
            `;

        data.authors.forEach((author, index) => {
          // æ•°æ®æ¥æºæ ‡è¯†
          const sourceColor =
            author.source === 'Google Scholar'
              ? 'bg-red-100 text-red-800'
              : author.source === 'OpenAlex'
              ? 'bg-blue-100 text-blue-800'
              : 'bg-gray-100 text-gray-600';
          const sourceLabel = author.source || 'æœªçŸ¥æ¥æº';

          const successIcon = author.searchSuccess
            ? '<i class="fa-solid fa-check-circle text-green-500 mr-1"></i>'
            : '<i class="fa-solid fa-exclamation-circle text-yellow-500 mr-1"></i>';

          // æ„å»ºä½œè€…åå­—é“¾æ¥
          const authorNameHtml = author.url
            ? `<a href="${author.url}" target="_blank" rel="noopener noreferrer"
                        class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">${author.name}</a>`
            : `<span class="font-semibold">${author.name}</span>`;

          html += `
                    <div class="border border-gray-100 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                ${successIcon}
                                ${authorNameHtml}
                                <span class="ml-2 text-xs px-2 py-0.5 rounded ${sourceColor}">${sourceLabel}</span>
                            </div>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">#${
                              index + 1
                            }</span>
                        </div>

                        <!-- æœºæ„ä¿¡æ¯ -->
                        <div class="text-sm text-gray-600 mb-2">
                            <i class="fa-solid fa-building mr-2"></i>
                            <span class="${
                              author.affiliation ? 'text-gray-800 font-medium' : 'text-gray-400'
                            }">
                                ${
                                  author.affiliation ||
                                  author.affiliations?.join('; ') ||
                                  'æœºæ„ä¿¡æ¯æœªçŸ¥'
                                }
                            </span>
                        </div>

                        <!-- ç ”ç©¶å…´è¶£æ ‡ç­¾ -->
                        ${
                          author.interests && author.interests.length > 0
                            ? `
                            <div class="mb-3">
                                <div class="flex flex-wrap gap-1">
                                    ${author.interests
                                      .slice(0, 5)
                                      .map(
                                        interest =>
                                          `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${interest}</span>`
                                      )
                                      .join('')}
                                </div>
                            </div>
                        `
                            : ''
                        }

                        <!-- ç»Ÿè®¡æ•°æ® -->
                        <div class="grid grid-cols-4 gap-2 text-xs mb-3">
                            <div class="bg-gray-50 rounded p-2 text-center">
                                <div class="font-semibold text-gray-800">${
                                  author.paperCount || 0
                                }</div>
                                <div class="text-gray-500">è®ºæ–‡æ•°</div>
                            </div>
                            <div class="bg-gray-50 rounded p-2 text-center">
                                <div class="font-semibold text-gray-800">${
                                  author.citationCount?.toLocaleString() || 0
                                }</div>
                                <div class="text-gray-500">å¼•ç”¨æ•°</div>
                            </div>
                            <div class="bg-gray-50 rounded p-2 text-center">
                                <div class="font-semibold text-gray-800">${
                                  author.hIndex || 'N/A'
                                }</div>
                                <div class="text-gray-500">HæŒ‡æ•°</div>
                            </div>
                            <div class="bg-gray-50 rounded p-2 text-center">
                                <div class="font-semibold text-gray-800">${
                                  author.i10Index || 'N/A'
                                }</div>
                                <div class="text-gray-500">i10æŒ‡æ•°</div>
                            </div>
                        </div>
                `;

          // è¿‘æœŸè®ºæ–‡
          if (author.recentPapers && author.recentPapers.length > 0) {
            html += `
                        <div class="border-t pt-2">
                            <div class="text-xs font-semibold text-gray-700 mb-2">
                                <i class="fa-solid fa-file-lines mr-1"></i> ä»£è¡¨ä½œå“:
                            </div>
                            <div class="space-y-1.5">
                    `;

            author.recentPapers.forEach(paper => {
              const paperTitle = paper.title || 'æœªçŸ¥æ ‡é¢˜';
              const truncatedTitle =
                paperTitle.length > 60 ? paperTitle.substring(0, 60) + '...' : paperTitle;

              html += `
                            <div class="text-xs text-gray-600 flex items-start">
                                <span class="text-gray-400 mr-1">â€¢</span>
                                <div class="flex-1">
                                    ${
                                      paper.url
                                        ? `<a href="${paper.url}" target="_blank" class="text-blue-600 hover:underline" title="${paperTitle}">${truncatedTitle}</a>`
                                        : `<span title="${paperTitle}">${truncatedTitle}</span>`
                                    }
                                    <span class="text-gray-400 ml-1">(${paper.year || '?'})</span>
                                </div>
                            </div>
                        `;
            });

            html += `</div></div>`;
          }

          // ä½œè€…ä¸»é¡µæŒ‰é’®
          if (author.url) {
            html += `
                        <div class="mt-3 pt-2 border-t border-gray-100 flex gap-2">
                            <a href="${author.url}" target="_blank" rel="noopener noreferrer"
                            style="color: white !important; background-color: #2563eb;"
                            class="inline-flex items-center text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 transition-colors">
                                <i class="fa-solid fa-external-link-alt mr-1.5"></i>
                                Google Scholar ä¸»é¡µ
                            </a>
                            ${
                              author.orcid
                                ? `
                                <a href="${author.orcid}" target="_blank" rel="noopener noreferrer"
                                style="color: white !important; background-color: #2563eb;"
                                class="inline-flex items-center text-xs bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 transition-colors">
                                    <i class="fa-brands fa-orcid mr-1.5"></i> ORCID
                                </a>
                            `
                                : ''
                            }
                        </div>
                    `;
          }

          html += `</div>`;
        });

        html += `</div></div>`;

        els.authorsContent.innerHTML = html;
      }

      // ä½œè€…ç¼–è¾‘åŠŸèƒ½
      els.editAuthorsBtn.addEventListener('click', () => {
        if (state.currentAuthors.length === 0) {
          alert('è¯·å…ˆè¿›è¡Œä½œè€…åˆ†æ');
          return;
        }

        // å°†å½“å‰ä½œè€…åˆ—è¡¨å¡«å……åˆ°æ–‡æœ¬åŒºåŸŸ
        const authorNames = state.currentAuthors.map(author => author.name);
        els.authorsTextarea.value = authorNames.join('\n');

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        els.authorsEditModal.classList.remove('hidden');
      });

      // å…³é—­æ¨¡æ€æ¡†
      els.closeEditModal.addEventListener('click', closeEditModal);
      els.cancelEdit.addEventListener('click', closeEditModal);

      function closeEditModal() {
        els.authorsEditModal.classList.add('hidden');
      }

      // ä¿å­˜ä½œè€…ç¼–è¾‘
      els.saveAuthors.addEventListener('click', async () => {
        const authorText = els.authorsTextarea.value.trim();
        if (!authorText) {
          alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªä½œè€…');
          return;
        }

        const updatedAuthors = authorText
          .split('\n')
          .map(name => name.trim())
          .filter(name => name.length > 0);

        if (updatedAuthors.length === 0) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä½œè€…å§“å');
          return;
        }

        els.saveAuthors.disabled = true;
        els.saveAuthors.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> ä¿å­˜ä¸­...';

        try {
          const response = await fetch('/api/update_authors', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              original_authors: state.originalAuthors,
              updated_authors: updatedAuthors,
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            if (result.fallback_data) {
              state.authorsAnalysis = result.fallback_data;
              renderAuthorsAnalysis(result.fallback_data, true);
              showNotification('ä½œè€…å·²æ›´æ–°ï¼ˆä½¿ç”¨ç¤ºä¾‹æ•°æ®ï¼‰', 'success');
            } else {
              throw new Error(result.error || `HTTP ${response.status}`);
            }
          } else if (result.success) {
            state.authorsAnalysis = result;
            state.currentAuthors = updatedAuthors;
            renderAuthorsAnalysis(result, false);
            showNotification('ä½œè€…ä¿¡æ¯å·²æˆåŠŸæ›´æ–°', 'success');
          } else {
            throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
          }

          closeEditModal();
        } catch (error) {
          console.error('ä½œè€…æ›´æ–°é”™è¯¯:', error);
          showNotification('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
        } finally {
          els.saveAuthors.disabled = false;
          els.saveAuthors.innerHTML = '<i class="fa-solid fa-check mr-2"></i> ä¿å­˜å¹¶é‡æ–°åˆ†æ';
        }
      });

      // æ·»åŠ é€šçŸ¥å‡½æ•°
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white ${
          type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fa-solid ${
                      type === 'success'
                        ? 'fa-check'
                        : type === 'error'
                        ? 'fa-exclamation'
                        : 'fa-info'
                    } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      els.authorsEditModal.addEventListener('click', e => {
        if (e.target === els.authorsEditModal) {
          closeEditModal();
        }
      });

      // å¼•ç”¨åˆ†æåŠŸèƒ½
      els.getCitationsBtn.addEventListener('click', async () => {
        if (!state.fullText) {
          alert('è¯·å…ˆä¸Šä¼ è®ºæ–‡ PDF');
          return;
        }

        els.getCitationsBtn.disabled = true;
        els.getCitationsBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> æœç´¢ä¸­...`;

        try {
          // å°è¯•ä»è®ºæ–‡å†…å®¹ä¸­æå–æ ‡é¢˜
          const titleMatch = state.fullText.match(/^(.{10,100}?)(?:\n|\.)/);
          const paperTitle = titleMatch ? titleMatch[1].trim() : 'å½“å‰è®ºæ–‡';

          const response = await fetch('/api/get_citations', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              title: state.paperTitle, // ç›´æ¥ä½¿ç”¨ä¿å­˜çš„æ ‡é¢˜
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            if (result.fallback_used && result.citations) {
              state.paperCitations = result;
              renderCitations(result, true);
            } else {
              throw new Error(result.error || `HTTP ${response.status}`);
            }
          } else if (result.success) {
            state.paperCitations = result;
            renderCitations(result, false);
          } else {
            throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
          }
        } catch (error) {
          console.error('å¼•ç”¨åˆ†æé”™è¯¯:', error);
          els.citationsContent.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <i class="fa-solid fa-exclamation-triangle text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm">å¼•ç”¨åˆ†æå¤±è´¥</p>
                        <p class="text-xs text-gray-300 mt-2">${error.message}</p>
                    </div>
                `;
        } finally {
          els.getCitationsBtn.disabled = false;
          els.getCitationsBtn.innerHTML = `<i class="fa-solid fa-magnifying-glass mr-2"></i> æŸ¥æ‰¾å¼•ç”¨`;
        }
      });

      function renderCitations(data, isFallback) {
        let html = '';

        if (isFallback) {
          html = `
                    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-600 mr-2"></i>
                            <span class="text-yellow-700 text-sm">ä½¿ç”¨ç¤ºä¾‹æ•°æ®ä¾›å‚è€ƒï¼ŒçœŸå®APIå¯èƒ½æš‚æ—¶å—é™</span>
                        </div>
                    </div>
                `;
        }

        // åŸå§‹è®ºæ–‡ä¿¡æ¯
        html += `
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
                    <h3 class="font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fa-solid fa-file-lines text-blue-600 mr-2"></i>
                        è¢«å¼•è®ºæ–‡ä¿¡æ¯
                    </h3>
                    <div class="text-sm text-gray-700">
                        <div class="flex items-start mb-2">
                            <span class="font-medium w-20 flex-shrink-0">æ ‡é¢˜:</span>
                            <span class="flex-1">${data.original_paper.title}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="font-medium w-20 flex-shrink-0">è¢«å¼•æ¬¡æ•°:</span>
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-semibold">
                                ${data.original_paper.citationCount} æ¬¡
                            </span>
                        </div>
                    </div>
                </div>
            `;

        // å¼•ç”¨è®ºæ–‡åˆ—è¡¨
        html += `
                <div class="bg-white rounded-lg border border-gray-200 p-4">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fa-solid fa-quote-left text-green-600 mr-2"></i>
                        å¼•ç”¨æ–‡çŒ® (${data.citations_count} ç¯‡)
                    </h3>
            `;

        if (data.citations && data.citations.length > 0) {
          data.citations.forEach((paper, index) => {
            const authors = paper.authors ? paper.authors.map(a => a.name).join(', ') : 'æœªçŸ¥ä½œè€…';
            const year = paper.year || 'æœªçŸ¥å¹´ä»½';
            const citationCount = paper.citationCount || 0;
            const venue = paper.venue || 'æœªçŸ¥æ¥æº';
            const abstract = paper.abstract || 'æš‚æ— æ‘˜è¦';

            html += `
                        <div class="border border-gray-100 rounded-lg p-4 mb-3 hover:bg-gray-50 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-gray-800 text-sm flex-1">${
                                  paper.title
                                }</h4>
                                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full ml-2">#${
                                  index + 1
                                }</span>
                            </div>

                            <div class="text-xs text-gray-600 mb-2">
                                <i class="fa-solid fa-user-group mr-1"></i> ${authors} |
                                <i class="fa-solid fa-calendar mr-1 ml-2"></i> ${year} |
                                <i class="fa-solid fa-quote-right mr-1 ml-2"></i> ${citationCount} å¼•ç”¨
                            </div>

                            <div class="text-xs text-gray-500 mb-2">
                                <i class="fa-solid fa-book mr-1"></i> ${venue}
                            </div>

                            <p class="text-xs text-gray-700 mb-3 leading-relaxed">${abstract}</p>

                            <div class="flex justify-end">
                                ${
                                  paper.url
                                    ? `
                                    <a href="${paper.url}" target="_blank"
                                    style="color: white !important; background-color: #2563eb;"
                                    class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition-colors">
                                        <i class="fa-solid fa-external-link-alt mr-1"></i> æŸ¥çœ‹åŸæ–‡
                                    </a>
                                `
                                    : ''
                                }
                            </div>
                        </div>
                    `;
          });
        } else {
          html += `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fa-solid fa-search text-3xl mb-2 opacity-20"></i>
                        <p>æœªæ‰¾åˆ°å¼•ç”¨æ–‡çŒ®</p>
                    </div>
                `;
        }

        html += `</div>`;
        els.citationsContent.innerHTML = html;
      }

      // åˆå§‹åŒ–ç¬”è®°åŠŸèƒ½
      function initNotes() {
        // ç»‘å®šäº‹ä»¶
        noteElements.globalNoteEditor.addEventListener('input', e => {
          state.notes.global = e.target.value; //
          state.notes.hasUnsavedChanges = true;
          updateSaveStatus();
        });

        noteElements.pageNoteEditor.addEventListener('input', e => {
          const currentPage = state.notes.currentPage || 1;
          state.notes.pages[currentPage] = e.target.value; //
          state.notes.hasUnsavedChanges = true;
          updateSaveStatus();
        });

        noteElements.saveNotesBtn.addEventListener('click', saveNotes);
        noteElements.loadNotesBtn.addEventListener('click', loadNotes);
        noteElements.copyPageNotes.addEventListener('click', copyPageNotes);
        noteElements.clearPageNotes.addEventListener('click', clearPageNotes);
        noteElements.exportNotesBtn.addEventListener('click', exportNotes);

        // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
        setInterval(() => {
          if (state.notes.hasUnsavedChanges) {
            autoSaveNotes();
          }
        }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜
      }

      // æ›´æ–°ä¿å­˜çŠ¶æ€æ˜¾ç¤º
      function updateSaveStatus() {
        const status = state.notes.hasUnsavedChanges ? 'æœªä¿å­˜' : 'å·²ä¿å­˜';
        document.querySelectorAll('#global-note-status, #page-note-status').forEach(el => {
          el.textContent = status;
          el.className = `text-xs ${
            state.notes.hasUnsavedChanges ? 'text-orange-500' : 'text-green-500'
          }`;
        });
      }

      // ä¿å­˜ç¬”è®°
      async function saveNotes() {
        if (!state.fullText) {
          alert('è¯·å…ˆä¸Šä¼ PDFæ–‡ä»¶');
          return;
        }

        try {
          noteElements.saveNotesBtn.disabled = true;
          noteElements.saveNotesBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i> ä¿å­˜ä¸­...';

          const response = await fetch('/api/save_note', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-API-Key': state.apiKey,
            },
            body: JSON.stringify({
              pdf_content: state.fullText.substring(0, 10000),
              notes: {
                global: state.notes.global,
                pages: state.notes.pages,
              },
            }),
          });

          const result = await response.json();

          if (result.success) {
            state.notes.hasUnsavedChanges = false;
            updateSaveStatus();
            updatePageThumbnails();
            showNotification('ç¬”è®°ä¿å­˜æˆåŠŸ', 'success');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('ä¿å­˜ç¬”è®°é”™è¯¯:', error);
          showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        } finally {
          noteElements.saveNotesBtn.disabled = false;
          noteElements.saveNotesBtn.innerHTML =
            '<i class="fa-solid fa-floppy-disk mr-2"></i> ä¿å­˜ç¬”è®°';
        }
      }

      // åŠ è½½ç¬”è®°
      async function loadNotes() {
        if (!state.fullText) {
          alert('è¯·å…ˆä¸Šä¼ PDFæ–‡ä»¶');
          return;
        }

        try {
          noteElements.loadNotesBtn.disabled = true;
          noteElements.loadNotesBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i> åŠ è½½ä¸­...';

          const response = await fetch('/api/load_note', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-API-Key': state.apiKey,
            },
            body: JSON.stringify({
              pdf_content: state.fullText.substring(0, 10000),
            }),
          });

          const result = await response.json();
          console.log('åŠ è½½ç¬”è®°ç»“æœ:', result);

          if (result.success && result.notes) {
            state.notes.global = result.notes.global || '';
            state.notes.pages = result.notes.pages || {};

            // æ›´æ–°è¾“å…¥æ¡†
            document.getElementById('global-note-editor').value = state.notes.global;

            const currentPage = state.notes.currentPage || 1;
            document.getElementById('page-note-editor').value =
              state.notes.pages[currentPage] || state.notes.pages[String(currentPage)] || '';

            // â­ æ›´æ–°é¡µé¢å¯¼èˆªå’Œé€‰æ‹©å™¨
            updatePageThumbnails();

            state.notes.hasUnsavedChanges = false;
            updateSaveStatus();

            alert('ç¬”è®°åŠ è½½æˆåŠŸ');
          } else {
            alert(result.message || 'æœªæ‰¾åˆ°å·²ä¿å­˜çš„ç¬”è®°');
          }
        } catch (error) {
          console.error('åŠ è½½ç¬”è®°é”™è¯¯:', error);
          alert('åŠ è½½å¤±è´¥: ' + error.message);
        } finally {
          noteElements.loadNotesBtn.disabled = false;
          noteElements.loadNotesBtn.innerHTML =
            '<i class="fa-solid fa-folder-open mr-2"></i> åŠ è½½ç¬”è®°';
        }
      }

      // å¯¼å‡ºç¬”è®°å‡½æ•°
      async function exportNotes() {
        const hasGlobal = state.notes.global && state.notes.global.trim();
        const hasPages = Object.values(state.notes.pages || {}).some(p => p && p.trim());

        if (!hasGlobal && !hasPages) {
          alert('æš‚æ— ç¬”è®°å¯å¯¼å‡º');
          return;
        }

        const exportBtn = document.getElementById('export-notes-btn');

        try {
          if (exportBtn) {
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> å¯¼å‡ºä¸­...';
          }

          const paperTitle = state.paperTitle || 'æœªå‘½åè®ºæ–‡';
          const content = generateMarkdown(paperTitle);
          const timestamp = new Date().toISOString().slice(0, 10);
          const filename = `è®ºæ–‡ç¬”è®°_${paperTitle}_${timestamp}.md`;

          downloadFile(content, filename, 'text/markdown');
          alert('ç¬”è®°å¯¼å‡ºæˆåŠŸï¼');
        } catch (error) {
          console.error('å¯¼å‡ºç¬”è®°é”™è¯¯:', error);
          alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
        } finally {
          if (exportBtn) {
            exportBtn.disabled = false;
            exportBtn.innerHTML = '<i class="fa-solid fa-download mr-2"></i> å¯¼å‡ºç¬”è®°';
          }
        }
      }

      // ç”Ÿæˆ Markdown æ ¼å¼
      function generateMarkdown(paperTitle) {
        let md = `# ğŸ“š è®ºæ–‡ç¬”è®°ï¼š${paperTitle}\n\n`;
        md += `**å¯¼å‡ºæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\n\n`;
        md += `---\n\n`;

        if (state.notes.global) {
          md += `## ğŸ“ å…¨å±€ç¬”è®°\n\n${state.notes.global}\n\n---\n\n`;
        }

        const pages = state.notes.pages || {};
        const sortedPages = Object.entries(pages)
          .filter(([_, content]) => content && content.trim())
          .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));

        if (sortedPages.length > 0) {
          md += `## ğŸ“„ é¡µé¢ç¬”è®°\n\n`;
          for (const [pageNum, content] of sortedPages) {
            md += `### ç¬¬ ${pageNum} é¡µ\n\n${content}\n\n`;
          }
        }

        return md;
      }

      // ä¸‹è½½æ–‡ä»¶
      function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();

        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      }

      function initPageNotes() {
        if (!state.pdfDoc) return;

        // æ¸…ç©ºç°æœ‰å†…å®¹
        noteElements.pageThumbnails.innerHTML = '';

        // ä¸ºæ¯ä¸€é¡µåˆ›å»ºç¼©ç•¥å›¾å’Œé€‰é¡¹
        for (let i = 1; i <= state.pdfDoc.numPages; i++) {
          // åˆ›å»ºç¼©ç•¥å›¾é¡¹
          const thumbItem = document.createElement('div');
          thumbItem.className = `page-thumbnail cursor-pointer p-2 rounded border-2 ${
            i === state.notes.currentPage
              ? 'border-blue-500 bg-blue-50'
              : 'border-transparent hover:bg-gray-100'
          }`;
          thumbItem.innerHTML = `
                    <div class="text-xs text-center mb-1 font-medium">ç¬¬ ${i} é¡µ</div>
                    <div class="bg-white border rounded p-1 text-center text-xs text-gray-400">
                        <i class="fa-solid fa-file-lines"></i>
                        ${state.notes.pages[i] ? 'æœ‰ç¬”è®°' : 'æ— ç¬”è®°'}
                    </div>
                `;
          thumbItem.addEventListener('click', () => switchPageNote(i));
          noteElements.pageThumbnails.appendChild(thumbItem);
        }

        // æ›´æ–°å½“å‰é¡µé¢æ˜¾ç¤º
        updatePageThumbnails();
      }

      function switchPageNote(pageNum) {
        // 1. å…ˆä¿å­˜å½“å‰é¡µé¢çš„å†…å®¹åˆ° state
        const currentPage = state.notes.currentPage || 1;
        const pageEditor = document.getElementById('page-note-editor');
        if (pageEditor && pageEditor.value) {
          state.notes.pages[currentPage] = pageEditor.value;
        }

        // 2. åˆ‡æ¢åˆ°æ–°é¡µé¢
        state.notes.currentPage = pageNum;

        // 3. â­ æ˜¾ç¤ºæ–°é¡µé¢çš„ç¬”è®°å†…å®¹
        if (pageEditor) {
          pageEditor.value = state.notes.pages[pageNum] || '';
        }

        // 4. æ›´æ–°é¡µé¢æ ‡ç­¾
        const currentPageLabel = document.getElementById('current-page-label');
        if (currentPageLabel) {
          currentPageLabel.textContent = `ç¬¬ ${pageNum} é¡µç¬”è®°`;
        }

        console.log(`åˆ‡æ¢åˆ°ç¬¬ ${pageNum} é¡µï¼Œå†…å®¹:`, state.notes.pages[pageNum] || '(ç©º)');
      }

      // æ›´æ–°é¡µé¢ç¬”è®°ç¼–è¾‘å™¨
      function updatePageThumbnails() {
        const container = document.getElementById('page-thumbnails');
        if (!container) return;

        const pageCount = state.pageCount || 10;
        const currentPage = state.notes.currentPage || 1;

        container.innerHTML = '';

        for (let i = 1; i <= pageCount; i++) {
          // â­ åŒæ—¶æ£€æŸ¥æ•°å­—å’Œå­—ç¬¦ä¸² key
          const hasNote = !!(state.notes.pages[i] || state.notes.pages[String(i)]);
          const isActive = i === currentPage;

          const thumb = document.createElement('div');
          thumb.className = `page-thumb cursor-pointer p-2 rounded border-2 text-center transition-all ${
            isActive ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-400'
          }`;

          thumb.innerHTML = `
                    <div class="text-xs font-medium ${
                      isActive ? 'text-blue-600' : 'text-gray-600'
                    }">
                        ç¬¬ ${i} é¡µ
                    </div>
                    <div class="text-xs mt-1 ${hasNote ? 'text-green-600' : 'text-gray-400'}">
                        ${hasNote ? '<i class="fa-solid fa-note-sticky"></i> æœ‰ç¬”è®°' : 'æ— ç¬”è®°'}
                    </div>
                `;

          thumb.addEventListener('click', () => {
            switchPageNote(i);
            updatePageThumbnails(); // æ›´æ–°é€‰ä¸­çŠ¶æ€
          });

          container.appendChild(thumb);
        }

        console.log('ç¼©ç•¥å›¾å·²æ›´æ–°ï¼Œpages:', state.notes.pages);
      }

      // å¤åˆ¶é¡µé¢ç¬”è®°
      function copyPageNotes() {
        const notes = state.notes.pages[state.notes.currentPage];
        if (notes) {
          navigator.clipboard.writeText(notes).then(() => {
            showNotification('ç¬”è®°å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
          });
        } else {
          showNotification('å½“å‰é¡µé¢æ²¡æœ‰ç¬”è®°', 'info');
        }
      }

      // æ¸…ç©ºé¡µé¢ç¬”è®°
      function clearPageNotes() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰é¡µé¢çš„ç¬”è®°å—ï¼Ÿ')) {
          delete state.notes.pages[state.notes.currentPage];
          noteElements.pageNoteEditor.value = '';
          state.notes.hasUnsavedChanges = true;
          updateSaveStatus();
          initPageNotes(); // é‡æ–°åˆå§‹åŒ–é¡µé¢æ˜¾ç¤º
          showNotification('é¡µé¢ç¬”è®°å·²æ¸…ç©º', 'success');
        }
      }

      // è‡ªåŠ¨ä¿å­˜
      function autoSaveNotes() {
        if (state.notes.hasUnsavedChanges) {
          saveNotes()
            .then(() => {
              console.log('ç¬”è®°å·²è‡ªåŠ¨ä¿å­˜');
            })
            .catch(error => {
              console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
            });
        }
      }

      // åœ¨PDFä¸Šä¼ æˆåŠŸååˆå§‹åŒ–ç¬”è®°åŠŸèƒ½
      function setupNotesAfterUpload() {
        // è®¡ç®—PDFå“ˆå¸Œ
        state.pdfHash = calculatePDFHash(state.fullText);

        // åˆå§‹åŒ–é¡µé¢ç¬”è®°
        initPageNotes();

        // å°è¯•è‡ªåŠ¨åŠ è½½ç°æœ‰ç¬”è®°
        setTimeout(() => {
          loadNotes();
        }, 1000);
      }

      // è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—PDFå“ˆå¸Œ
      function calculatePDFHash(text) {
        // ç®€å•çš„å“ˆå¸Œå‡½æ•°ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„æ–¹æ³•
        let hash = 0;
        for (let i = 0; i < Math.min(text.length, 1000); i++) {
          const char = text.charCodeAt(i);
          hash = (hash << 5) - hash + char;
          hash = hash & hash; // Convert to 32bit integer
        }
        return hash.toString(16);
      }
    </script>
  </body>
</html>
